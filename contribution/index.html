<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="Contribution" /><meta property="og:locale" content="en" /><meta name="description" content="Commit SHA: 40ed6d66d2b42437c3f9b6ebed0cf63bfda4e3b6 Author: simonmicro Date: 2024-05-19T13:16:43Z" /><meta property="og:description" content="Commit SHA: 40ed6d66d2b42437c3f9b6ebed0cf63bfda4e3b6 Author: simonmicro Date: 2024-05-19T13:16:43Z" /><link rel="canonical" href="https://ruffalolavoisier.github.io/contribution/" /><meta property="og:url" content="https://ruffalolavoisier.github.io/contribution/" /><meta property="og:site_name" content="Unforgettable" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-08-16T23:53:43+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Contribution" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-08-16T23:53:43+09:00","datePublished":"2024-08-16T23:53:43+09:00","description":"Commit SHA: 40ed6d66d2b42437c3f9b6ebed0cf63bfda4e3b6 Author: simonmicro Date: 2024-05-19T13:16:43Z","headline":"Contribution","mainEntityOfPage":{"@type":"WebPage","@id":"https://ruffalolavoisier.github.io/contribution/"},"url":"https://ruffalolavoisier.github.io/contribution/"}</script><title>Contribution | Unforgettable</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Unforgettable"><meta name="application-name" content="Unforgettable"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return 'mode'; } static get MODE_ATTR() { return 'data-mode'; } static get DARK_MODE() { return 'dark'; } static get LIGHT_MODE() { return 'light'; } static get ID() { return 'mode-toggle'; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia('(prefers-color-scheme: dark)'); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { document.documentElement.removeAttribute(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage( { direction: ModeToggle.ID, message: this.modeStatus }, '*' ); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script> <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script> <script>mermaid.initialize({startOnLoad:true});</script><body> <video autoplay muted loop id="video-background"> <source src="/assets/img/back.mp4" type="video/mp4"> Your browser does not support the video tag. </video><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"> <img src="https://ruffalolavoisier.github.io/assets/img/profile.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"> </a><div class="site-title"> <a href="/">Unforgettable</a></div><div class="site-subtitle fst-italic">I wonder Why I wonder</div></div><ul class="nav flex-column flex-grow-1 w-100 ps-0"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/project/" class="nav-link"> <i class="fa-fw fas fa-laptop-code"></i> <span>PROJECT</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a><li class="nav-item active"> <a href="/contribution/" class="nav-link"> <i class="fa-fw fas fa-code-merge"></i> <span>CONTRIBUTION</span> </a></ul><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/RuffaloLavoisier" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="javascript:location.href = 'mailto:' + ['RuffaloLavoisier','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="https://stackoverflow.com/users/17522538/ruffalo" aria-label="stack-overflow" target="_blank" rel="noopener noreferrer" > <i class="fab fa-stack-overflow"></i> </a></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container px-xxl-5"><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100" > <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Contribution</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Contribution</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </span> <span id="search-cancel">Cancel</span></div></div><div class="row mb-5"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pe-xl-4"><div class="post px-1 px-md-2"><h1 class="dynamic-title"> Contribution</h1><div class="post-content"><p>Commit SHA: 40ed6d66d2b42437c3f9b6ebed0cf63bfda4e3b6 Author: simonmicro Date: 2024-05-19T13:16:43Z</p><p>Files changed: .github/workflows/astyle.yml</p><p>Patch: @@ -12,8 +12,10 @@ jobs: runs-on: ubuntu-latest if: $ steps:</p><ul><li><ul><li>uses: actions/checkout@v1</ul><li><ul><li>name: Checkout repository and submodules</ul><li>uses: nschloe/action-cached-lfs-checkout@v1 with:<li><h1 id="submodules-recursive--do-not-access-any-submodules-to-not-accidentially-modify-them">submodules: recursive # do not access any submodules to not accidentially modify them</h1><p>ref: $ - name: astyle uses: addnab/docker-run-action@v3</p></ul><p>Commit SHA: 40ed6d66d2b42437c3f9b6ebed0cf63bfda4e3b6 Author: simonmicro Date: 2024-05-19T13:16:43Z</p><p>Files changed: .github/workflows/test-EMULATOR.yml</p><p>Patch: @@ -2,9 +2,9 @@ name: Build OSW Emulator (Ubuntu)</p><p>on: push:</p><ul><li>paths_ignore: ‘[“<strong>/*.md”, “</strong>/scripts/screen_capture/**”]’<li>paths-ignore: [“<strong>/*.md”, “</strong>/scripts/screen_capture/**”] pull_request:<li>branches: [ master, develop ]<li>branches: [master, develop]</ul><p>jobs: check_skip: @@ -13,10 +13,11 @@ jobs: should_skip: $ steps: - id: skip_check</p><ul><li>uses: fkirc/skip-duplicate-actions@v5.2.0<li>uses: fkirc/skip-duplicate-actions@v5 with:<li>concurrent_skipping: ‘same_content_newer’<li>skip_after_successful_duplicate: ‘true’<li>cancel_others: “true” # in a PR with two runs (push+merge), the latter will cancel the first and run instead<li>concurrent_skipping: “same_content_newer”<li>skip_after_successful_duplicate: “true”</ul><p>build-EMULATOR: runs-on: ubuntu-22.04 @@ -25,24 +26,36 @@ jobs: strategy: matrix: build-configuration: [Debug, Release]</p><ul><li>steps:<li><ul><li>name: Checkout repository and submodules</ul><li><h1 id="uses-actionscheckoutv3--incompatible-with-git-lfs-cache-bandwidth-calcs-httpsgithubcomactionscheckoutissues165">uses: actions/checkout@v3 # incompatible with git lfs cache bandwidth calcs (https://github.com/actions/checkout/issues/165)</h1><li>uses: nschloe/action-cached-lfs-checkout@v1.2.1<li>with:<li>submodules: recursive<li>lfs: ‘true’<li><ul><li>name: Update packages</ul><li>run: sudo apt-get update<li><ul><li>name: Install packages</ul><li>run: sudo apt-get -y install gcc g++ cmake libsdl2-dev libsdl2-image-dev python3 python3-pip<li><ul><li>name: Install python packages</ul><li>run: pip3 install –user -r scripts/requirements.txt<li><ul><li>name: Create build directory</ul><li>run: mkdir build<li><ul><li>name: CMake $</ul><li>run: cd build &amp;&amp; cmake -DCMAKE_BUILD_TYPE=$ ..<li><ul><li>name: Make</ul><li>run: cd build &amp;&amp; make -j $(nproc)<li><ul><li>name: Test</ul><li>run: cd build &amp;&amp; make test<li>steps:<li><h1 id="the-following-is-incompatible-with-git-lfs-cache-bandwidth-calculations-httpsgithubcomactionscheckoutissues165">the following is incompatible with git lfs cache bandwidth calculations (https://github.com/actions/checkout/issues/165)</h1><li><h1 id="--we-removed-the-following-and-replaced-it-with-a-cache-aware-checkout">-&gt; we removed the following and replaced it with a cache-aware checkout</h1><li><h1 id="--name-checkout-repository-and-submodules">- name: Checkout repository and submodules</h1><li><h1 id="uses-actionscheckoutv3">uses: actions/checkout@v3</h1><li><h1 id="with">with:</h1><li><h1 id="submodules-recursive">submodules: recursive</h1><li><h1 id="lfs-true">lfs: ‘true’</h1><li><ul><li>name: Checkout repository and submodules</ul><li>uses: nschloe/action-cached-lfs-checkout@v1<li>with:<li>submodules: recursive<li><ul><li>name: Update packages</ul><li>run: sudo apt-get update<li><ul><li>name: Install packages</ul><li>run: sudo apt-get -y install gcc g++ cmake libsdl2-dev libsdl2-image-dev python3 python3-pip<li><ul><li>name: Install python packages</ul><li>run: pip3 install –user -r scripts/requirements.txt<li><ul><li>name: Create build directory</ul><li>run: mkdir build<li><ul><li>name: CMake $</ul><li>run: cd build &amp;&amp; cmake -DCMAKE_BUILD_TYPE=$ ..<li><ul><li>name: Make</ul><li>run: cd build &amp;&amp; make -j $(nproc)<li><ul><li>name: Test</ul><li>run: cd build &amp;&amp; make test<li><ul><li>name: Upload test artifacts</ul><li>if: failure()<li>uses: actions/upload-artifact@v4<li>with:<li>name: test-results<li><div class="table-wrapper"><table><tbody><tr><td>path:</table></div><li>build/Testing</ul><p>Commit SHA: 40ed6d66d2b42437c3f9b6ebed0cf63bfda4e3b6 Author: simonmicro Date: 2024-05-19T13:16:43Z</p><p>Files changed: .github/workflows/test-FEATURE.yml</p><p>Patch: @@ -2,9 +2,9 @@ name: Build OSW-OS (Ubuntu, additional features)</p><p>on: push:</p><ul><li>paths_ignore: ‘[“*.md”, “<strong>/scripts/screen_capture/</strong>”]’<li>paths-ignore: [“*.md”, “<strong>/scripts/screen_capture/</strong>”] pull_request:<li>branches: [ master, develop ]<li>branches: [master, develop]</ul><p>jobs: check_skip: @@ -13,22 +13,21 @@ jobs: should_skip: $ steps: - id: skip_check</p><ul><li>uses: fkirc/skip-duplicate-actions@v5.2.0<li>uses: fkirc/skip-duplicate-actions@v5 with:<li>concurrent_skipping: ‘same_content_newer’<li>skip_after_successful_duplicate: ‘true’<li>cancel_others: “true” # in a PR with two runs (push+merge), the latter will cancel the first and run instead<li>concurrent_skipping: “same_content_newer”<li>skip_after_successful_duplicate: “true”</ul><p>Find-feature: runs-on: ubuntu-latest needs: check_skip if: $</p><ul><li>steps:<li>steps:<ul><li>name: Checkout repository and submodules</ul><li><h1 id="uses-actionscheckoutv3--incompatible-with-git-lfs-cache-bandwidth-calcs-httpsgithubcomactionscheckoutissues165-1">uses: actions/checkout@v3 # incompatible with git lfs cache bandwidth calcs (https://github.com/actions/checkout/issues/165)</h1><li>uses: nschloe/action-cached-lfs-checkout@v1.2.1<li>uses: nschloe/action-cached-lfs-checkout@v1 with: submodules: recursive<li>lfs: ‘true’ - id: get-flag run: | echo “feature=$(python3 .github/getWorkflowMatrix.py all_flags)” » $GITHUB_OUTPUT @@ -52,31 +51,29 @@ jobs: model: $ language: $ steps:<li><ul><li>name: Checkout repository and submodules</ul><li><h1 id="uses-actionscheckoutv3--incompatible-with-git-lfs-cache-bandwidth-calcs-httpsgithubcomactionscheckoutissues165-2">uses: actions/checkout@v3 # incompatible with git lfs cache bandwidth calcs (https://github.com/actions/checkout/issues/165)</h1><li>uses: nschloe/action-cached-lfs-checkout@v1.2.1<li>with:<li>submodules: recursive<li>lfs: ‘true’<li><ul><li>name: Cache pip</ul><li>uses: actions/cache@v3<li>with:<li>path: ~/.cache/pip<li>key: pip-$<li><ul><li>name: Cache PlatformIO</ul><li>uses: actions/cache@v3<li>with:<li>path: ~/.platformio<li>key: platformio-$<li><ul><li>name: Install swig</ul><li>run: sudo apt-get update &amp;&amp; sudo apt-get -y install swig<li><ul><li>name: Set up Python</ul><li>uses: actions/setup-python@v4<li>with:<li>python-version: ‘3.10’<li><ul><li>name: Install PlatformIO</ul><li>run: python -m pip install –upgrade pip &amp;&amp; pip install –upgrade platformio<li><ul><li>name: Rename config</ul><li>run: mv include/config.h.example include/config.h<li><ul><li>name: Compile language $ model $ feature $</ul><li>run: python3 .github/buildFirmware.py -l “$” -m “$” -f “$” -b debug<li><ul><li>name: Checkout repository and submodules</ul><li>uses: nschloe/action-cached-lfs-checkout@v1<li>with:<li>submodules: recursive<li><ul><li>name: Cache pip</ul><li>uses: actions/cache@v4<li>with:<li>path: ~/.cache/pip<li>key: pip-$<li><ul><li>name: Cache PlatformIO</ul><li>uses: actions/cache@v4<li>with:<li>path: ~/.platformio<li>key: platformio-$<li><ul><li>name: Install swig</ul><li>run: sudo apt-get update &amp;&amp; sudo apt-get -y install swig<li><ul><li>name: Set up Python</ul><li>uses: actions/setup-python@v5<li>with:<li>python-version: “3.10”<li><ul><li>name: Install PlatformIO</ul><li>run: python -m pip install –upgrade pip &amp;&amp; pip install –upgrade platformio<li><ul><li>name: Rename config</ul><li>run: mv include/config.h.example include/config.h<li><ul><li>name: Compile language $ model $ feature $</ul><li>run: python3 .github/buildFirmware.py -l “$” -m “$” -f “$” -b debug</ul><p>Commit SHA: 40ed6d66d2b42437c3f9b6ebed0cf63bfda4e3b6 Author: simonmicro Date: 2024-05-19T13:16:43Z</p><p>Files changed: .github/workflows/test-OS.yml</p><p>Patch: @@ -4,19 +4,17 @@ on: workflow_dispatch: pull_request: schedule:</p><ul><li><ul><li>cron: ‘0 0 * * *’</ul><li><ul><li>cron: “0 0 * * *”</ul></ul><p>jobs: Find-feature: runs-on: ubuntu-latest</p><ul><li>steps:<li>steps:<ul><li>name: Checkout repository and submodules</ul><li><h1 id="uses-actionscheckoutv3--incompatible-with-git-lfs-cache-bandwidth-calcs-httpsgithubcomactionscheckoutissues165-3">uses: actions/checkout@v3 # incompatible with git lfs cache bandwidth calcs (https://github.com/actions/checkout/issues/165)</h1><li>uses: nschloe/action-cached-lfs-checkout@v1.2.1<li>uses: nschloe/action-cached-lfs-checkout@v1 with: submodules: recursive<li>lfs: ‘true’<li><ul><li>uses: dorny/paths-filter@v2.11.1</ul><li><ul><li>uses: dorny/paths-filter@v3 id: filter with: filters: | @@ -45,34 +43,35 @@ jobs: model: $ language: $ steps:</ul><li><ul><li>name: Checkout repository and submodules</ul><li><h1 id="uses-actionscheckoutv3--incompatible-with-git-lfs-cache-bandwidth-calcs-httpsgithubcomactionscheckoutissues165-4">uses: actions/checkout@v3 # incompatible with git lfs cache bandwidth calcs (https://github.com/actions/checkout/issues/165)</h1><li>uses: nschloe/action-cached-lfs-checkout@v1.2.1<li>with:<li>submodules: recursive<li>lfs: ‘true’<li><ul><li>name: Cache pip</ul><li>uses: actions/cache@v3<li>with:<li>path: ~/.cache/pip<li>key: pip-$<li><ul><li>name: Cache PlatformIO</ul><li>uses: actions/cache@v3<li>with:<li>path: ~/.platformio<li>key: platformio-$<li><ul><li>name: Set up Python</ul><li>uses: actions/setup-python@v4<li>with:<li>python-version: ‘3.10’<li><ul><li>name: Checkout repository and submodules</ul><li>uses: nschloe/action-cached-lfs-checkout@v1<li>with:<li>submodules: recursive<li><ul><li>name: Cache pip</ul><li>uses: actions/cache@v4<li>with:<li>path: ~/.cache/pip<li>key: pip-$<li><ul><li>name: Cache PlatformIO</ul><li>uses: actions/cache@v4<li>with:<li>path: ~/.platformio<li><p>key: platformio-$</p><li><ul><li>name: Install PlatformIO</ul><li>shell: bash<li><div class="table-wrapper"><table><tbody><tr><td>run:</table></div><li>apt update &amp;&amp; apt -y install swig<li>python -m pip install –upgrade pip<li>pip install –upgrade platformio<li>mv include/config.h.example include/config.h<li><ul><li>name: Install swig on Linux</ul><li>if: matrix.os == ‘ubuntu-latest’<li>run: sudo apt-get update &amp;&amp; sudo apt-get -y install swig<li><ul><li>name: Install swig on Mac OS</ul><li>if: matrix.os == ‘macos-latest’<li><p>run: brew install swig</p><li><ul><li>name: Compile language $ model $</ul><li>run: python3 .github/buildFirmware.py -l “$” -m “$” -b debug<li><ul><li>name: Set up Python</ul><li>uses: actions/setup-python@v5<li>with:<li>python-version: “3.10”<li><ul><li>name: Install PlatformIO</ul><li>run: python -m pip install –upgrade pip &amp;&amp; pip install –upgrade platformio<li><ul><li>name: Rename config</ul><li>run: mv include/config.h.example include/config.h<li><ul><li>name: Compile language $ model $</ul><li>run: python3 .github/buildFirmware.py -l “$” -m “$” -b debug</ul><p>Commit SHA: 40ed6d66d2b42437c3f9b6ebed0cf63bfda4e3b6 Author: simonmicro Date: 2024-05-19T13:16:43Z</p><p>Files changed: .github/workflows/test-OSW.yml</p><p>Patch: @@ -3,9 +3,9 @@ name: Build OSW-OS (Ubuntu, all models) on: workflow_dispatch: push:</p><ul><li>paths_ignore: ‘[“*.md”, “<strong>/scripts/screen_capture/</strong>”]’<li>paths-ignore: [“*.md”, “<strong>/scripts/screen_capture/</strong>”] pull_request:<li>branches: [ master, develop ]<li>branches: [master, develop]</ul><p>jobs: check_skip: @@ -14,23 +14,22 @@ jobs: should_skip: $ steps: - id: skip_check</p><ul><li>uses: fkirc/skip-duplicate-actions@v5.2.0<li>uses: fkirc/skip-duplicate-actions@v5 with:<li>concurrent_skipping: ‘same_content_newer’<li>skip_after_successful_duplicate: ‘true’<li>cancel_others: “true” # in a PR with two runs (push+merge), the latter will cancel the first and run instead<li>concurrent_skipping: “same_content_newer”<li>skip_after_successful_duplicate: “true”</ul><p>Find-packages: runs-on: ubuntu-latest needs: check_skip if: $</p><ul><li>steps:<li>steps:<ul><li>name: Checkout repository and submodules</ul><li><h1 id="uses-actionscheckoutv3--incompatible-with-git-lfs-cache-bandwidth-calcs-httpsgithubcomactionscheckoutissues165-5">uses: actions/checkout@v3 # incompatible with git lfs cache bandwidth calcs (https://github.com/actions/checkout/issues/165)</h1><li>uses: nschloe/action-cached-lfs-checkout@v1.2.1<li>uses: nschloe/action-cached-lfs-checkout@v1 with: submodules: recursive<li>lfs: ‘true’<li><ul><li>uses: dorny/paths-filter@v2.11.1</ul><li><ul><li>uses: dorny/paths-filter@v3 id: filter with: filters: | @@ -48,6 +47,7 @@ jobs: outputs: languages_matrix: $ models_matrix: $ + build-OSW: needs: Find-packages runs-on: ubuntu-latest @@ -58,37 +58,35 @@ jobs: model: $ build-configuration: [debug, release] steps:</ul><li><ul><li>name: Checkout repository and submodules</ul><li><h1 id="uses-actionscheckoutv3--incompatible-with-git-lfs-cache-bandwidth-calcs-httpsgithubcomactionscheckoutissues165-6">uses: actions/checkout@v3 # incompatible with git lfs cache bandwidth calcs (https://github.com/actions/checkout/issues/165)</h1><li>uses: nschloe/action-cached-lfs-checkout@v1.2.1<li>with:<li>submodules: recursive<li>lfs: ‘true’<li><ul><li>name: Cache pip</ul><li>uses: actions/cache@v3<li>with:<li>path: ~/.cache/pip<li>key: pip-$<li><ul><li>name: Cache PlatformIO</ul><li>uses: actions/cache@v3<li>with:<li>path: ~/.platformio<li>key: platformio-$<li><ul><li>name: Install swig</ul><li>run: sudo apt-get update &amp;&amp; sudo apt-get -y install swig<li><ul><li>name: Set up Python</ul><li>uses: actions/setup-python@v4<li>with:<li>python-version: ‘3.10’<li><ul><li>name: Install PlatformIO</ul><li>run: python -m pip install –upgrade pip &amp;&amp; pip install –upgrade platformio<li><ul><li>name: Rename config</ul><li>run: mv include/config.h.example include/config.h<li><ul><li>name: Compile language $ model $</ul><li>run: python3 .github/buildFirmware.py -l “$” -m “$” -b “$”<li><ul><li>name: Upload firmware artifacts</ul><li>uses: actions/upload-artifact@v3<li>with:<li>name: firmwares<li><div class="table-wrapper"><table><tbody><tr><td>path:</table></div><li>*.bin<li><ul><li>name: Checkout repository and submodules</ul><li>uses: nschloe/action-cached-lfs-checkout@v1<li>with:<li>submodules: recursive<li><ul><li>name: Cache pip</ul><li>uses: actions/cache@v4<li>with:<li>path: ~/.cache/pip<li>key: pip-$<li><ul><li>name: Cache PlatformIO</ul><li>uses: actions/cache@v4<li>with:<li>path: ~/.platformio<li>key: platformio-$<li><ul><li>name: Install swig</ul><li>run: sudo apt-get update &amp;&amp; sudo apt-get -y install swig<li><ul><li>name: Set up Python</ul><li>uses: actions/setup-python@v5<li>with:<li>python-version: “3.10”<li><ul><li>name: Install PlatformIO</ul><li>run: python -m pip install –upgrade pip &amp;&amp; pip install –upgrade platformio<li><ul><li>name: Rename config</ul><li>run: mv include/config.h.example include/config.h<li><ul><li>name: Compile language $ model $</ul><li>run: python3 .github/buildFirmware.py -l “$” -m “$” -b “$”<li><ul><li>name: Upload firmware artifacts</ul><li>uses: actions/upload-artifact@v3<li>with:<li>name: firmwares<li><div class="table-wrapper"><table><tbody><tr><td>path:</table></div><li>*.bin</ul><p>Commit SHA: 40ed6d66d2b42437c3f9b6ebed0cf63bfda4e3b6 Author: simonmicro Date: 2024-05-19T13:16:43Z</p><p>Files changed: CMakeLists.txt</p><p>Patch: @@ -141,7 +141,9 @@ target_compile_definitions(emulator.run PUBLIC # LOCALE=”locales/en-US.h” # Comment these as you wish… OSW_FEATURE_STATS_STEPS</p><ul><li>OSW_APPS_EXAMPLES=1<li>OSW_FEATURE_WEATHER<li>OSW_SERVICE_CONSOLE<li>OSW_APPS_EXAMPLES GAME_SNAKE=1 GAME_BRICK_BREAKER=1 TOOL_FLASHLIGHT=1</ul><p>Commit SHA: 40ed6d66d2b42437c3f9b6ebed0cf63bfda4e3b6 Author: simonmicro Date: 2024-05-19T13:16:43Z</p><p>Files changed: README.md</p><p>Patch: @@ -51,14 +51,27 @@ If you want to compile for a specific model, you can use the <code class="language-plaintext highlighter-rouge">-e</code> flag with an ` ## Hack it! To get started, take a look into the examples in the <code class="language-plaintext highlighter-rouge">src/apps/examples</code> folder - or just into any other app. If you want to compile the examples or other (by default) excluded applications, take a look into the <code class="language-plaintext highlighter-rouge">main.cpp</code> file and add the respective flags to the <code class="language-plaintext highlighter-rouge">platformio.ini</code> file.</p><p>-## Debugging (CLI) +## CLI</p><p>If you want to print out the log for debugging (also including decoded exception traces), use the following command:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre> <span class="nv">$ </span>pio device monitor
</pre></table></code></div></div><p>+In this serial console you also have the ability (beside much more) to configure the watch - just type in <code class="language-plaintext highlighter-rouge">help</code> to get started: +``` +OSW &gt; help +Available commands:</p><ul><li>configure - enter configuration mode<li>help - show this help<li>hostname - show the device hostname<li>lock - lock the console<li>reboot - warm-start the device forcefully<li>time - show current UTC time<li>wipe - format NVS partition and reset configuration +``` + ## Creating Screenshots of your Apps</ul><p align="center"> @@ -98,6 +111,7 @@ $ cd scripts/screen_capture/ $ ./createScreenshot.sh <IP_OF_WATCH> <SCREENSHOT> ``` * The captured file can be found in the `screenshot/` folder inside the `open-smartwatch-os` directory. + ## Troubleshooting For more information on troubleshooting, see [Wiki](https://open-smartwatch.github.io/resources/firmware/#troubleshooting). Commit SHA: 40ed6d66d2b42437c3f9b6ebed0cf63bfda4e3b6 Author: simonmicro Date: 2024-05-19T13:16:43Z Files changed: docs/firmware/apps/OswWeather.md Patch: @@ -1,5 +1,7 @@ -# OSW WEATHER +# OSW WEATHER +![](/assets/apps/OswWeather/h.png) +Author: [@LorenzoSciacca](https://github.com/Lorenzosciacca) ## How to install Add the flag `OSW_FEATURE_WEATHER` to the file `platformio.ini`: ```ini @@ -58,7 +60,8 @@ The / \ and \ / arrows are used to decrease/increase the current selection (da - Humidity: [relative humidity](https://en.wikipedia.org/wiki/Humidity#Relative_humidity) - Pressure: [hPa](https://en.wikipedia.org/wiki/Pascal_(unit)#Multiples_and_submultiples) -### Weather conditions +### Weather conditions + Visit [this link](https://openweathermap.org/weather-conditions#Weather-Condition-Codes-2) for a more detailed description of each weather condition.<div class="table-wrapper"><table> @@ -164,4 +167,10 @@ Visit [this link](https://openweathermap.org/weather-conditions#Weather-Conditio<td>Unknown<td> &lt;/tr&gt; -</table></div>\ No newline at end of file +&lt;/table&gt; + +## Using the emulator +To use this app while using the OSW emulator, in order to retireve the data, it is necessary to perform the API request using the browser and to save the response in `file_weather.json` in the `/build` folder. + + + Commit SHA: 40ed6d66d2b42437c3f9b6ebed0cf63bfda4e3b6 Author: simonmicro Date: 2024-05-19T13:16:43Z Files changed: docs/firmware/osw_os.md Patch: @@ -12,6 +12,15 @@ Flag | Description | Requirements `GPS_EDITION` | Configure the build for use with GPS (including apps, api, sensors) | `PROGMEM_TILES`, `BOARD_HAS_PSRAM` `GPS_EDITION_ROTATED` | Replacement for `GPS_EDITION` to work with flipped boards | - +## Example Flags + +You want to know how to use some example code or see it in action? These flags enable vairous features that are not enabled by default - just search inside the source code for the flag to see how it works and what it does. + +Flag | Description | Requirements +----------- | ----------- | ----------- +`OSW_SERVICE_EXAMPLE` | Enable the example code to demonstrate how to write on services. | - +`OSW_APPS_EXAMPLES` | Enable the example code to demonstrate how to write own apps (v1/v2). | - + ## Experimental Flags These flags should be available on all models. Because they are experimental, they are not enabled by default any may won't work or even compile. Commit SHA: 40ed6d66d2b42437c3f9b6ebed0cf63bfda4e3b6 Author: simonmicro Date: 2024-05-19T13:16:43Z Files changed: emulator/include/Arduino_GFX.h Patch: @@ -3,4 +3,7 @@ class Graphics2DPrint; typedef Graphics2DPrint Arduino_GFX; -#include "Arduino_G.h" \ No newline at end of file +// in accordance to Arduino_DataBus.h also provide this define +#define GFX_NOT_DEFINED -1 + +#include "Arduino_G.h" Commit SHA: 40ed6d66d2b42437c3f9b6ebed0cf63bfda4e3b6 Author: simonmicro Date: 2024-05-19T13:16:43Z Files changed: emulator/include/Serial.h Patch: @@ -9,7 +9,7 @@ class Serial_t { public: - Serial_t() {}; + Serial_t(); ~Serial_t() {}; std::list&lt;std::stringstream&gt; buffer; @@ -40,8 +40,12 @@ class Serial_t { this-&gt;println(); } + int available(); + int read(); + void println(); private: + std::list<char> inputBuffer; int bauds = 0; bool buffered = false; bool addBufferNewline = true; Commit SHA: 40ed6d66d2b42437c3f9b6ebed0cf63bfda4e3b6 Author: simonmicro Date: 2024-05-19T13:16:43Z Files changed: emulator/src/Serial.cpp Patch: @@ -1,8 +1,18 @@ #include "../include/Serial.h" #include <OswLogger.h> +#include <iostream> +#include <unistd.h> +#include <fcntl.h> + Serial_t Serial; +Serial_t::Serial_t() { + // put the stdin-stream into non-blocking mode to avoid hanging in case available() is called + int flags = fcntl(STDIN_FILENO, F_GETFL, 0); + fcntl(STDIN_FILENO, F_SETFL, flags | O_NONBLOCK); +} + void Serial_t::setBuffered(bool buffered) { this-&gt;buffered = buffered; this-&gt;addBufferNewline = true; @@ -26,4 +36,21 @@ void Serial_t::println() { this-&gt;addBufferNewline = true; else std::cout &lt;&lt; std::endl; +} + +int Serial_t::available() { + char c; + if(::read(STDIN_FILENO, &amp;c, 1) &gt; 0) { + this-&gt;inputBuffer.push_back(c); + return true; + } + return false; +} + +int Serial_t::read() { + if(this-&gt;inputBuffer.empty()) + return -1; + char c = this-&gt;inputBuffer.front(); + this-&gt;inputBuffer.pop_front(); + return c; } \ No newline at end of file Commit SHA: 40ed6d66d2b42437c3f9b6ebed0cf63bfda4e3b6 Author: simonmicro Date: 2024-05-19T13:16:43Z Files changed: emulator/src/tests/unitTests/logging.cpp Patch: @@ -10,7 +10,7 @@ * be bound to the stack-frame of its test - and destroyed upon leaving. */ -#define EXPECT_LASTLINE(expect) EXPECT_STREQ(expect, Serial.buffer.back().str().c_str()) +#define EXPECT_LASTLINE(expect) EXPECT_STREQ(expect, (Serial.buffer.size() ? Serial.buffer.back().str().c_str() : "")) // Defines to use check log messages (all except debug!) #ifndef NDEBUG Commit SHA: 40ed6d66d2b42437c3f9b6ebed0cf63bfda4e3b6 Author: simonmicro Date: 2024-05-19T13:16:43Z Files changed: include/Arduino_Canvas_Graphics2D.h Patch: @@ -22,7 +22,7 @@ class Arduino_Canvas_Graphics2D : public Graphics2DPrint { * we have copy-pasted this utility together... */ - void begin(int32_t speed = 0); + void begin(int32_t speed = GFX_NOT_DEFINED); void writePixelPreclipped(int16_t x, int16_t y, uint16_t color); void writeFastVLine(int16_t x, int16_t y, int16_t h, uint16_t color); void writeFastHLine(int16_t x, int16_t y, int16_t w, uint16_t color); Commit SHA: 40ed6d66d2b42437c3f9b6ebed0cf63bfda4e3b6 Author: simonmicro Date: 2024-05-19T13:16:43Z Files changed: include/apps/_experiments/OswAppWeather.h Patch: @@ -3,6 +3,7 @@ #include <osw_hal.h> #include <vector> #include <OswAppV1.h> +#include "ArduinoJson.h" #include "OswAppWeatherIconPrinter.h" class OswAppWeather : public OswApp { @@ -20,6 +21,52 @@ class OswAppWeather : public OswApp { virtual void stop() override; ~OswAppWeather() {}; private: + class WeatherDecoder { + public: + WeatherDecoder(const String&amp; input_String); + bool strIsValid(); + time_t getTime(); + std::vector&lt;OswAppWeather::weather_update_t&gt; getUpdates(); + private: + time_t _str2time(const String&amp; t); + int _str2temp(const String&amp; temp); + int _str2hum(const String&amp; humidity); + int _str2pres(const String&amp; pressure); + int _str2wthr(const String&amp; weather); + bool in_ok = true; + int nUpdates = 0; + String in_String; + }; + + class WeatherParser { + public: + WeatherParser(); + std::optional<String> encodeWeather(DynamicJsonDocument&amp; doc); + private: + int _getWCond(int weather_code); + int cnt; + std::vector&lt;OswAppWeather::weather_update_t&gt; updates; + std::vector<int>clearCode{800};//0 + std::vector<int>cloudsMin{801};//1 + std::vector<int>cloudsMed{802};//2 + std::vector<int>cloudsHigh{803, 804};//3 + std::vector<int>mist{701};//4 + std::vector<int>fog{741};//5 + std::vector<int>snowMin{611, 612, 615, 616};//6 + std::vector<int>snowMed{600, 613, 601, 620};//7 + std::vector<int>snowHigh{602, 621, 622};//8 + std::vector<int>rainMin{500, 300, 301, 302, 310, 311, 312, 313, 314, 321};//9 + std::vector<int>rainMed{502, 501};//10 + std::vector<int>rainHigh{503, 504, 511, 520, 521, 522, 531};//11 + std::vector<int>thunderstorm{200, 201, 210, 211, 231, 230};//12 + std::vector<int>thunderstormHeavy{202, 212, 221, 232};//13 + std::vector<int>squallTornado{771, 781};//14 + //15 -&gt;unknown + std::vector&lt;std::vector<int>&gt;weather_conditions{clearCode, cloudsMin, cloudsMed, cloudsHigh, mist, fog, snowMin, snowMed, + snowHigh, rainMin, rainMed, rainHigh, thunderstorm, + thunderstormHeavy, squallTornado }; + }; + void getW(); void printW(); void drawLayout(); @@ -46,7 +93,7 @@ class OswAppWeather : public OswApp { uint8_t daySelector = 0; uint8_t placeSelector = 0; uint8_t updtSelector = 0; - OswHal* hal = OswHal::getInstance(); + OswHal* hal = nullptr; std::vector<weather_update_t> forecast;//one update each 3h time_t initTimestamp; char initTimeMD[6]; @@ -60,5 +107,6 @@ class OswAppWeather : public OswApp { tm* tmInit; std::vector<int> dayFirstUpdt{};// n-th entry is the index of first update of the n-th day bool _request(); + void drawPopUp(); }; -#endif \ No newline at end of file +#endif Commit SHA: 40ed6d66d2b42437c3f9b6ebed0cf63bfda4e3b6 Author: simonmicro Date: 2024-05-19T13:16:43Z Files changed: include/apps/_experiments/OswAppWeatherEncoder.h Patch: @@ -1,13 +1,16 @@ #pragma once #ifdef OSW_FEATURE_WEATHER + +#include <optional> + #include "apps/_experiments/OswAppWeather.h" class OswAppWeatherEncoder { public: OswAppWeatherEncoder(); bool setUpdate(OswAppWeather::weather_update_t update); bool setTimestamp(time_t t); - String getEncoded(); + std::optional<String> getEncoded(); private: String _time2str(time_t time); Commit SHA: 40ed6d66d2b42437c3f9b6ebed0cf63bfda4e3b6 Author: simonmicro Date: 2024-05-19T13:16:43Z Files changed: include/osw_config.h Patch: @@ -47,6 +47,7 @@ class OswConfig { String getCategoriesJson(); String getFieldJson(String id); void setField(String id, String value); + void resetField(String id); void notifyChange(); protected: Preferences prefs; // for the config keys accessible Commit SHA: 40ed6d66d2b42437c3f9b6ebed0cf63bfda4e3b6 Author: simonmicro Date: 2024-05-19T13:16:43Z Files changed: include/services/OswServiceTaskConsole.h Patch: @@ -0,0 +1,22 @@ +#pragma once +#include "osw_service.h" + +class OswServiceTaskConsole : public OswServiceTask { + public: + OswServiceTaskConsole() {}; + virtual void setup() override; + virtual void loop() override; + virtual void stop() override; + ~OswServiceTaskConsole() {}; + + private: + void newPrompt(); + void showPrompt(); + void runPrompt(); + void showHelp(); + + std::string m_inputBuffer; + bool m_locked = false; + unsigned char m_lockCounter = 0; + bool m_configuring = false; +}; \ No newline at end of file Commit SHA: 40ed6d66d2b42437c3f9b6ebed0cf63bfda4e3b6 Author: simonmicro Date: 2024-05-19T13:16:43Z Files changed: include/services/OswServiceTaskExample.h Patch: @@ -1,6 +1,5 @@ -#ifndef OSW_SERVICE_TASKEXAMPLE_H -#define OSW_SERVICE_TASKEXAMPLE_H - +#pragma once +#include <time.h> #include "osw_service.h" class OswServiceTaskExample : public OswServiceTask { @@ -14,5 +13,3 @@ class OswServiceTaskExample : public OswServiceTask { private: time_t printLimit = 0; }; - -#endif \ No newline at end of file Commit SHA: 40ed6d66d2b42437c3f9b6ebed0cf63bfda4e3b6 Author: simonmicro Date: 2024-05-19T13:16:43Z Files changed: lib/Arduino_GFX Patch: @@ -1 +1 @@ -Subproject commit 4aaf9074d5db1055c67f2d91bde1f4f113f7e5b6 +Subproject commit 5a203a36778e1929fd86d4f2542edada9dfbd793 Commit SHA: 40ed6d66d2b42437c3f9b6ebed0cf63bfda4e3b6 Author: simonmicro Date: 2024-05-19T13:16:43Z Files changed: lib/open-smartwatch-web Patch: @@ -1 +1 @@ -Subproject commit df4e89fcbf0e4eaf9d34d3bc6f6269d26d21f88d +Subproject commit 7e59541511c93f664d9ded8db499cb8a7a09df39 Commit SHA: 40ed6d66d2b42437c3f9b6ebed0cf63bfda4e3b6 Author: simonmicro Date: 2024-05-19T13:16:43Z Files changed: platformio.ini Patch: @@ -44,13 +44,15 @@ build_unflags = -std=gnu++11 # The correct flag will be set by the cppflags pyth build_flags = -D OSW_TARGET_PLATFORM_HEADER='"platform/LIGHT_EDITION_V3_3.h"' -D OSW_FEATURE_STATS_STEPS + -D OSW_SERVICE_CONSOLE -D OSW_FEATURE_WIFI build_type = debug [env:LIGHT_EDITION_V4_0] build_flags = -D OSW_TARGET_PLATFORM_HEADER='"platform/LIGHT_EDITION_V4_0.h"' -D OSW_FEATURE_STATS_STEPS + -D OSW_SERVICE_CONSOLE -D OSW_FEATURE_WIFI -D OSW_FEATURE_WIFI_ONBOOT build_type = debug @@ -60,6 +62,7 @@ build_type = debug build_flags = -D OSW_TARGET_PLATFORM_HEADER='"platform/LIGHT_EDITION_V3_3.h"' -D OSW_FEATURE_LUA + -D OSW_SERVICE_CONSOLE -D OSW_FEATURE_WIFI -D LUA_C89_NUMBERS ; Required by OSW_FEATURE_LUA extra_scripts = @@ -78,6 +81,7 @@ build_flags = -D BOARD_HAS_PSRAM -mfix-esp32-psram-cache-issue -D OSW_FEATURE_STATS_STEPS + -D OSW_SERVICE_CONSOLE -D OSW_FEATURE_WIFI -D OSW_FEATURE_WIFI_APST -D OSW_FEATURE_WIFI_ONBOOT @@ -92,6 +96,7 @@ build_flags = -D BOARD_HAS_PSRAM -mfix-esp32-psram-cache-issue -D OSW_FEATURE_STATS_STEPS + -D OSW_SERVICE_CONSOLE -D OSW_FEATURE_WIFI -D OSW_FEATURE_WIFI_APST -D OSW_FEATURE_WIFI_ONBOOT Commit SHA: 40ed6d66d2b42437c3f9b6ebed0cf63bfda4e3b6 Author: simonmicro Date: 2024-05-19T13:16:43Z Files changed: src/apps/_experiments/OswAppWeather.cpp Patch: @@ -3,59 +3,48 @@ #include "apps/_experiments/OswAppWeatherEncoder.h" #include "services/OswServiceTaskWiFi.h" #include &lt;services/OswServiceTasks.h&gt; -#include <HTTPClient.h> #include <cstring> #include <gfx_util.h> #include <OswAppV1.h> #include <osw_hal.h> #include "fonts/DS_DIGI12pt7b.h" -#include "ArduinoJson.h" - +#ifndef OSW_EMULATOR +#include <HTTPClient.h> +#endif #define OPENWEATHERMAP_URL "https://api.openweathermap.org/data/2.5/forecast?q=" #define URL_REQ OPENWEATHERMAP_URL OPENWEATHERMAP_CITY "," OPENWEATHERMAP_STATE_CODE "&amp;appid=" OPENWEATHERMAP_APIKEY "&amp;cnt=24" +#ifdef OSW_EMULATOR +#include <iostream> +#include <fstream> +#endif /* TODO: multiple location support measurement unit conversion (?) */ -class WeatherDecoder { - public: - WeatherDecoder(const String&amp; input_String); - bool strIsValid(); - time_t getTime(); - std::vector&lt;OswAppWeather::weather_update_t&gt; getUpdates(); - private: - time_t _str2time(const String&amp; t); - int _str2temp(const String&amp; temp); - int _str2hum(const String&amp; humidity); - int _str2pres(const String&amp; pressure); - int _str2wthr(const String&amp; weather); - bool in_ok = true; - int nUpdates = 0; - String in_String; -}; - -WeatherDecoder::WeatherDecoder(const String&amp; input_String) { + + +OswAppWeather::WeatherDecoder::WeatherDecoder(const String&amp; input_String) { if(input_String.length() &lt; 16 || (input_String.length()%8)!= 0 ) { this-&gt;in_ok = false; } this-&gt;in_String = input_String; this-&gt;nUpdates = (this-&gt;in_String.length()-8)/8; } -bool WeatherDecoder::strIsValid() { +bool OswAppWeather::WeatherDecoder::strIsValid() { return in_ok; } -time_t WeatherDecoder::getTime() { +time_t OswAppWeather::WeatherDecoder::getTime() { String time_str = this-&gt;in_String.substring(0,8); time_t t = this-&gt;_str2time(time_str); return t; } -std::vector&lt;OswAppWeather::weather_update_t&gt; WeatherDecoder::getUpdates() { +std::vector&lt;OswAppWeather::weather_update_t&gt; OswAppWeather::WeatherDecoder::getUpdates() { OswAppWeather::weather_update_t update; String update_str; std::vector&lt;OswAppWeather::weather_update_t&gt; updates; @@ -70,78 +59,47 @@ std::vector&lt;OswAppWeather::weather_update_t&gt; WeatherDecoder::getUpdates() { return updates; } -time_t WeatherDecoder::_str2time(const String&amp; t) { +time_t OswAppWeather::WeatherDecoder::_str2time(const String&amp; t) { int time = t.toInt(); time = time * 8; time = 2147483647 - time; return time; } -int WeatherDecoder::_str2temp(const String&amp; temp) { +int OswAppWeather::WeatherDecoder::_str2temp(const String&amp; temp) { int temp_int = temp.toInt(); return temp_int; } -int WeatherDecoder::_str2hum(const String&amp; humidity) { +int OswAppWeather::WeatherDecoder::_str2hum(const String&amp; humidity) { int hum = humidity.toInt(); hum = (hum*10)+ 5; return hum; } -int WeatherDecoder::_str2pres(const String&amp; pressure) { +int OswAppWeather::WeatherDecoder::_str2pres(const String&amp; pressure) { int pres = pressure.toInt(); pres = pres + 850; return pres; } -int WeatherDecoder::_str2wthr(const String&amp; weather) { +int OswAppWeather::WeatherDecoder::_str2wthr(const String&amp; weather) { char wthr = weather[0]; return wthr - 65; } +OswAppWeather::WeatherParser::WeatherParser() {} - -class WeatherParser { - public: - WeatherParser(); - String encodeWeather(DynamicJsonDocument&amp; doc); - private: - int _getWCond(int weather_code); - int cnt; - std::vector&lt;OswAppWeather::weather_update_t&gt; updates; - std::vector<int>clearCode{800};//0 - std::vector<int>cloudsMin{801};//1 - std::vector<int>cloudsMed{802};//2 - std::vector<int>cloudsHigh{803, 804};//3 - std::vector<int>mist{701};//4 - std::vector<int>fog{741};//5 - std::vector<int>snowMin{611, 612, 615, 616};//6 - std::vector<int>snowMed{600, 613, 601, 620};//7 - std::vector<int>snowHigh{602, 621, 622};//8 - std::vector<int>rainMin{500, 300, 301, 302, 310, 311, 312, 313, 314, 321};//9 - std::vector<int>rainMed{502, 501};//10 - std::vector<int>rainHigh{503, 504, 511, 520, 521, 522, 531};//11 - std::vector<int>thunderstorm{200, 201, 210, 211, 231, 230};//12 - std::vector<int>thunderstorHeavy{202, 212, 221, 232};//13 - std::vector<int>squallTornado{771, 781};//14 - //15 -&gt;unknown - std::vector&lt;std::vector<int>&gt;weather_conditions{clearCode, cloudsMin, cloudsMed, cloudsHigh, mist, fog, snowMin, snowMed, - snowHigh, rainMin, rainMed, rainHigh, thunderstorm, - thunderstorHeavy, squallTornado }; -}; - -WeatherParser::WeatherParser() {} - -String WeatherParser::encodeWeather(DynamicJsonDocument&amp; doc) { +std::optional<String> OswAppWeather::WeatherParser::encodeWeather(DynamicJsonDocument&amp; doc) { const char* code = nullptr; code = doc["cod"]; if(strcmp("200",code)) { if(code==nullptr) { OSW_LOG_E("Error, corrupted API response."); - return "ERROR_CORRUPTED_RESPONSE"; + return std::nullopt; // ERROR_CORRUPTED_RESPONSE } else { OSW_LOG_E("Error, response code: ", code); - return "ERROR_API_RESPONSE"; + return std::nullopt; // ERROR_API_RESPONSE } } cnt = doc["cnt"]; @@ -159,15 +117,16 @@ String WeatherParser::encodeWeather(DynamicJsonDocument&amp; doc) { update.weather = this-&gt;_getWCond(doc["list"][i]["weather"][0]["id"]); res = encoder.setUpdate(update); if (!res) { + OSW_LOG_E("Failed to pass update to encoder!"); return "ERROR_INPUT"; } } return encoder.getEncoded(); } -int WeatherParser::_getWCond(int weather_code) { +int OswAppWeather::WeatherParser::_getWCond(int weather_code) { for(int i=0; i&lt;15; i++) { - for(int j=0; j &lt; weather_conditions[i].size(); j++) { + for(size_t j=0; j &lt; weather_conditions[i].size(); j++) { if(weather_code == weather_conditions[i][j]) { return i; } @@ -176,7 +135,22 @@ int WeatherParser::_getWCond(int weather_code) { return 15; // unknown weather def } +void OswAppWeather::drawPopUp() { + this-&gt;hal-&gt;gfx()-&gt;drawThickLine(50,120,190,120,15,rgb888(255,255,255),true); + this-&gt;hal-&gt;gfx()-&gt;drawThickLine(51,120,189,120,14,rgb888(0,0,0),true); + this-&gt;hal-&gt;gfx()-&gt;setTextCursor(120,120); + this-&gt;hal-&gt;gfx()-&gt;setTextColor(rgb888(255,255,255)); + this-&gt;hal-&gt;gfx()-&gt;setTextCenterAligned(); + this-&gt;hal-&gt;gfx()-&gt;setTextMiddleAligned(); + this-&gt;hal-&gt;gfx()-&gt;print("connecting..."); +} + + void OswAppWeather::drawWeather() { + if(this-&gt;updtSelector &gt;= this-&gt;forecast.size()) { + return; + } + updtTime = initTimestamp + (this-&gt;updtSelector * 10800 ); this-&gt;printWIcon.drawIcon(this-&gt;forecast[this-&gt;updtSelector].weather,120,45,1); //draw time of current weather updatea @@ -252,7 +226,7 @@ void OswAppWeather::printLastUpdate() { this-&gt;hal-&gt;gfx()-&gt;setTextCursor(120, 225); this-&gt;hal-&gt;gfx()-&gt;print(this-&gt;initTimeDMY); } - +#ifndef OSW_EMULATOR void OswAppWeather::weatherRequest() { if(!OswServiceAllTasks::wifi.isConnected()) { OswServiceAllTasks::wifi.enableWiFi(); @@ -262,53 +236,69 @@ void OswAppWeather::weatherRequest() { } bool OswAppWeather::_request() { + // TODO cleanup the error handling (especially the return false; statements) HTTPClient http; - OSW_LOG_I(this-&gt;url); - http.begin(this-&gt;url, OPENWEATHERMAP_CA_CERT); int code = 0; + OSW_LOG_D("Request: "); + OSW_LOG_D(this-&gt;url); + http.begin(this-&gt;url, OPENWEATHERMAP_CA_CERT); if (OswServiceAllTasks::wifi.isConnected()) { OswHal::getInstance()-&gt;disableDisplayBuffer(); this-&gt;forecast.clear(); - this-&gt;dataLoaded=false; - OSW_LOG_I("free heap ", ESP.getFreeHeap()); + this-&gt;dataLoaded = false; + OSW_LOG_D("free heap ", ESP.getFreeHeap()); code = http.GET(); } else { return false; } http.end(); OswServiceAllTasks::wifi.disconnectWiFi(); - OSW_LOG_I("code:", code); - if (code == 200) { - DynamicJsonDocument doc(16432); - deserializeJson(doc,http.getStream()); - WeatherParser pars; - String encoded = pars.encodeWeather(doc); - int encoded_len = encoded.length(); - char encoded_arr[encoded_len + 1]; - strcpy(encoded_arr, encoded.c_str()); - String encoded_S = String(encoded_arr); - if (!this-&gt;pref.putString("wtr",encoded_S)) { - OSW_LOG_E("Error: unable to write to NVS"); - this-&gt;dataLoaded = false; - return false; - } - } else { - OSW_LOG_E("Error: API response: ", code); + OSW_LOG_D("Request returned code: ", code); + if (code != HTTP_CODE_OK) { + OSW_LOG_E("Unexpected API response: ", code); + this-&gt;dataLoaded = false; + return false; + } + DynamicJsonDocument doc(16432); + deserializeJson(doc,http.getStream()); + WeatherParser pars; + std::optional<String> encoded = pars.encodeWeather(doc); + if(!encoded.has_value()) { + OSW_LOG_E("Something went wrong with the encoding of the weather data?!"); + this-&gt;dataLoaded = false; + return false; + } + int encoded_len = encoded.value().length(); + char encoded_arr[encoded_len + 1]; + strcpy(encoded_arr, encoded.value().c_str()); + String encoded_S = String(encoded_arr); + if (!this-&gt;pref.putString("wtr",encoded_S)) { + OSW_LOG_E("Unable to write weather-update to NVS?!"); this-&gt;dataLoaded = false; return false; } this-&gt;requestMode=false; bool res = this-&gt;loadData(); - if (res) { - OSW_LOG_I("weather updated correctly"); - this-&gt;dataLoaded=true; - return true; - } else { + if (!res) { this-&gt;dataLoaded = false; return false; } - + OSW_LOG_D("weather updated correctly"); + this-&gt;dataLoaded=true; + return true; +} +#else +void OswAppWeather::weatherRequest() { + this-&gt;requestMode = true; +} +bool OswAppWeather::_request() { + // in emulator instantly "fullfill" the request + this-&gt;requestMode=false; + this-&gt;dataLoaded=true; + return true; } +#endif + void OswAppWeather::getDayList(int nUpdates) { time_t timestamp = this-&gt;initTimestamp; @@ -379,9 +369,36 @@ void OswAppWeather::printDate() { } bool OswAppWeather::loadData() { - String wstr = this-&gt;pref.getString("wtr"); - if (!wstr.equals("")) { - OSW_LOG_I("size of wstr: ", wstr.length()); + String wstr; +#ifdef OSW_EMULATOR + std::ifstream inFile; + inFile.open("file_weather.json"); //open the input file + if(!inFile.is_open()) { + OSW_LOG_E("Unable to open 'file_weather.json' in the current working directory"); + OSW_LOG_W("→ Because the emulator has no HTTP-capabilities (yet), you need to provide this file manually for now."); + } else { + std::stringstream strStream; + strStream &lt;&lt; inFile.rdbuf(); + std::string strW = strStream.str(); + OSW_LOG_D("json file raw:"); + OSW_LOG_D(strW); + DynamicJsonDocument doc(16432*2);// when in emulator more space is needed + deserializeJson(doc,strW); + WeatherParser pars; + std::optional<String> encoded = pars.encodeWeather(doc); + if(encoded.has_value()) { + OSW_LOG_D("as encoded:"); + OSW_LOG_D(encoded.value()); + wstr += encoded.value(); // this copies the value of "encoded" to "wstr" (just assignment does not take ownership of the value itself) + } else { + OSW_LOG_E("Something went wrong with the encoding of the weather data from the local file?!"); + } + } +#else + wstr = this-&gt;pref.getString("wtr"); +#endif + if (wstr!="") { + OSW_LOG_D("size of wstr: ", wstr.length()); if( (wstr.length() % 8) != 0 ) { this-&gt;dataLoaded = false; return false; @@ -393,11 +410,11 @@ bool OswAppWeather::loadData() { WeatherDecoder decoder(wstr.c_str()); this-&gt;initTimestamp = decoder.getTime(); this-&gt;getDayList(); - if(strftime(this-&gt;initTimeDMY, sizeof(this-&gt;initTimeDMY), "%d/%m/%Y", localtime(&amp;this-&gt;initTimestamp))) { - //OSW_LOG_I(this-&gt;inittimeDMY); + if(!strftime(this-&gt;initTimeDMY, sizeof(this-&gt;initTimeDMY), "%d/%m/%Y", localtime(&amp;this-&gt;initTimestamp))) { + OSW_LOG_W("Failed to parse timestamp: ", this-&gt;initTimeDMY); } - if(strftime(this-&gt;initTimeMD, sizeof(this-&gt;initTimeMD), "%d/%m", localtime(&amp;this-&gt;initTimestamp))) { - //OSW_LOG_I(this-&gt;initTimeMD); + if(!strftime(this-&gt;initTimeMD, sizeof(this-&gt;initTimeMD), "%d/%m", localtime(&amp;this-&gt;initTimestamp))) { + OSW_LOG_W("Failed to parse timestamp: ", this-&gt;initTimeMD); } tmInit = localtime(&amp;this-&gt;initTimestamp); forecast = decoder.getUpdates(); @@ -411,7 +428,7 @@ bool OswAppWeather::loadData() { } int OswAppWeather::getNextDay() { - for(int i=0; i<this->dayFirstUpdt.size(); i++) { + for(size_t i=0; i<this->dayFirstUpdt.size(); i++) { if(this-&gt;dayFirstUpdt[i] &gt; this-&gt;updtSelector) { return this-&gt;dayFirstUpdt[i]; } @@ -430,19 +447,23 @@ int OswAppWeather::getPrevDay() { void OswAppWeather::setup() { + OSW_LOG_D("OSW Weather Setup "); this-&gt;location1 = OswConfigAllKeys::weatherLocation1.get(); this-&gt;state1 = OswConfigAllKeys::weatherState1.get(); this-&gt;api_key = OswConfigAllKeys::weatherApiKey.get(); this-&gt;url = String(OPENWEATHERMAP_URL); - this-&gt;url.concat(this-&gt;location1); - this-&gt;url.concat(","); - this-&gt;url.concat(this-&gt;state1); - this-&gt;url.concat("&amp;appid="); - this-&gt;url.concat(this-&gt;api_key); - this-&gt;url.concat("&amp;cnt=24"); - pref.begin("wheater-app"); + this-&gt;url = this-&gt;url + this-&gt;location1; + this-&gt;url = this-&gt;url + ","; + this-&gt;url = this-&gt;url + this-&gt;state1; + this-&gt;url = this-&gt;url + "&amp;appid="; + this-&gt;url = this-&gt;url + this-&gt;api_key; + this-&gt;url = this-&gt;url + "&amp;cnt=24"; + pref.begin("wheater-app", false); this-&gt;loadData(); + this-&gt;hal = OswHal::getInstance(); // ALWAYS update cached hal reference, as it may change at any point (strictly speaking, it should be updated in every loop, but this is a good place to start with) + // ↑ this is fixed in OswAppV2 where you always have the up-to-date hal reference available this-&gt;printWIcon.getHal(this-&gt;hal); + OSW_LOG_D("Setup end"); } void OswAppWeather::loop() { @@ -453,27 +474,29 @@ void OswAppWeather::loop() { this-&gt;printDate(); this-&gt;printLastUpdate(); } + +#ifndef OSW_EMULATOR if(this-&gt;requestMode) { if (OswServiceAllTasks::wifi.isConnected()) { this-&gt;_request(); - } else {//pop-up - this-&gt;hal-&gt;gfx()-&gt;drawThickLine(50,120,190,120,15,rgb888(255,255,255),true); - this-&gt;hal-&gt;gfx()-&gt;drawThickLine(51,120,189,120,14,rgb888(0,0,0),true); - this-&gt;hal-&gt;gfx()-&gt;setTextCursor(120,120); - this-&gt;hal-&gt;gfx()-&gt;setTextColor(rgb888(255,255,255)); - this-&gt;hal-&gt;gfx()-&gt;setTextCenterAligned(); - this-&gt;hal-&gt;gfx()-&gt;setTextMiddleAligned(); - this-&gt;hal-&gt;gfx()-&gt;print("connecting..."); + } else { + this-&gt;drawPopUp(); } } +#else + if(this-&gt;requestMode) { + this-&gt;_request(); + this-&gt;drawPopUp(); + } +#endif if (hal-&gt;btnHasGoneDown(BUTTON_2)) { if(this-&gt;mainSelector==1) { // next update if(this-&gt;updtSelector&lt;23) { this-&gt;updtSelector++; } } if(this-&gt;mainSelector==0) { //next day - if(this-&gt;updtSelector &gt;= this-&gt;dayFirstUpdt[this-&gt;dayFirstUpdt.size()-1]) { + if(this-&gt;dayFirstUpdt.size() &gt; 0 and this-&gt;updtSelector &gt;= this-&gt;dayFirstUpdt[this-&gt;dayFirstUpdt.size()-1]) { this-&gt;updtSelector=this-&gt;updtSelector; } else { this-&gt;updtSelector = this-&gt;getNextDay(); @@ -511,4 +534,4 @@ void OswAppWeather::loop() { void OswAppWeather::stop() { } -#endif \ No newline at end of file +#endif Commit SHA: 40ed6d66d2b42437c3f9b6ebed0cf63bfda4e3b6 Author: simonmicro Date: 2024-05-19T13:16:43Z Files changed: src/apps/_experiments/OswAppWeatherEncoder.cpp Patch: @@ -6,15 +6,19 @@ OswAppWeatherEncoder::OswAppWeatherEncoder() {} bool OswAppWeatherEncoder::setUpdate(OswAppWeather::weather_update_t update) { bool update_ok = true; if(update.temp &gt; 99 || update.temp &lt; -99 ) { + OSW_LOG_W("Invalid TEMPERATURE: ", update.temp); update_ok = false; } if(update.humidity &gt; 100 || update.humidity &lt; 0) { + OSW_LOG_W("Invalid HUMIDITY: ", update.humidity); update_ok = false; } if(update.pressure &lt; 0 || update.pressure &gt; 2000 ) { + OSW_LOG_W("Invalid PRESSURE: ", update.pressure); update_ok = false; } if(update.weather &lt; 0 || update.weather &gt; 15) { + OSW_LOG_W("Invalid WEATHER: ", update.weather); update_ok = false; } if(!update_ok) { @@ -39,14 +43,14 @@ bool OswAppWeatherEncoder::setTimestamp(time_t t) { return false; } -String OswAppWeatherEncoder::getEncoded() { +std::optional<String> OswAppWeatherEncoder::getEncoded() { if(this-&gt;time_loaded) { String encoded; encoded += _time2str(this-&gt;timestamp); encoded += this-&gt;updates; return encoded; } else { - return "error_no_timestamp"; + return std::nullopt; // error_no_timestamp } } Commit SHA: 40ed6d66d2b42437c3f9b6ebed0cf63bfda4e3b6 Author: simonmicro Date: 2024-05-19T13:16:43Z Files changed: src/apps/tools/OswAppFlashLight.cpp Patch: @@ -31,20 +31,22 @@ void OswAppFlashLight::onStart() { void OswAppFlashLight::onDraw() { OswAppV2::onDraw(); + const uint16_t whiteColor = rgb888to565(rgb888(255, 255, 255)); + const uint16_t blackColor = rgb888to565(rgb888(0, 0, 0)); this-&gt;hal-&gt;gfx()-&gt;fillCircle(120, 120, 120, ui-&gt;getSuccessColor()); if (this-&gt;on) { - this-&gt;hal-&gt;gfx()-&gt;fillCircle(120, 120, 115, ui-&gt;getForegroundColor()); + this-&gt;hal-&gt;gfx()-&gt;fillCircle(120, 120, 115, whiteColor); this-&gt;hal-&gt;gfx()-&gt;setTextSize(3); this-&gt;hal-&gt;gfx()-&gt;setTextCenterAligned(); this-&gt;hal-&gt;gfx()-&gt;setTextCursor(120, 125); - this-&gt;hal-&gt;gfx()-&gt;setTextColor(ui-&gt;getBackgroundColor()); + this-&gt;hal-&gt;gfx()-&gt;setTextColor(blackColor); this-&gt;hal-&gt;gfx()-&gt;print(int(hal-&gt;screenBrightness())); //displays the current brightness } else { - this-&gt;hal-&gt;gfx()-&gt;fillCircle(120, 120, 115, ui-&gt;getBackgroundColor()); + this-&gt;hal-&gt;gfx()-&gt;fillCircle(120, 120, 115, blackColor); this-&gt;hal-&gt;gfx()-&gt;setTextSize(3.5); this-&gt;hal-&gt;gfx()-&gt;setTextCenterAligned(); this-&gt;hal-&gt;gfx()-&gt;setTextCursor(120, 125); - this-&gt;hal-&gt;gfx()-&gt;setTextColor(ui-&gt;getForegroundColor()); + this-&gt;hal-&gt;gfx()-&gt;setTextColor(whiteColor); this-&gt;hal-&gt;gfx()-&gt;print("Flashlight"); } } Commit SHA: 40ed6d66d2b42437c3f9b6ebed0cf63bfda4e3b6 Author: simonmicro Date: 2024-05-19T13:16:43Z Files changed: src/hal/display.cpp Patch: @@ -70,7 +70,7 @@ void OswHal::setupDisplay() { if(!this-&gt;canvas) this-&gt;canvas = new Arduino_Canvas_Graphics2D(DISP_W, DISP_H, tft); - this-&gt;canvas-&gt;begin(0); + this-&gt;canvas-&gt;begin(); // use default speed and default SPI mode this-&gt;displayOn(); } Commit SHA: 40ed6d66d2b42437c3f9b6ebed0cf63bfda4e3b6 Author: simonmicro Date: 2024-05-19T13:16:43Z Files changed: src/main.cpp Patch: @@ -205,7 +205,7 @@ void loop() { main_mainDrawer.registerApp("GPS", new OswAppV2Compat("osw.gps.mc", "Magnetometer Calibrate", gpsOswAppMC)); #endif -#if OSW_APPS_EXAMPLES == 1 +#ifdef OSW_APPS_EXAMPLES // For a short "How to write your own apps" see the examples below main_mainDrawer.registerAppLazy<OswAppExampleV2>(LANG_EXAMPLES); // only v2 apps support lazy loading (for now) static OswAppExampleV1 exampleV1; // this is a static object, so it will be kept in memory until the device is reset - but it kind of defeats the purpose of lazy loading (static object = initialized on bootup, not on first use) Commit SHA: 40ed6d66d2b42437c3f9b6ebed0cf63bfda4e3b6 Author: simonmicro Date: 2024-05-19T13:16:43Z Files changed: src/osw_config.cpp Patch: @@ -87,6 +87,7 @@ void OswConfig::reset(bool clearWholeNVS) { bool res; if(clearWholeNVS) { this-&gt;prefs.end(); + OSW_LOG_D("Formatting NVS partition..."); res = nvs_flash_erase() == ESP_OK; assert(res); res = nvs_flash_init() == ESP_OK; @@ -155,6 +156,18 @@ void OswConfig::setField(String id, String value) { this-&gt;notifyChange(); } +void OswConfig::resetField(String id) { + unsigned char i = 0; + for (; i &lt; oswConfigKeysCount; i++) { + OswConfigKey* key = oswConfigKeys[i]; + if(String(key-&gt;id) == id) { + key-&gt;fromString(key-&gt;toDefaultString().c_str()); + break; + } + } + this-&gt;notifyChange(); +} + void OswConfig::notifyChange() { // Reload parts of the OS, which buffer values // OswUI::getInstance()-&gt;resetTextColors(); // nope - this is done by the ui itself Commit SHA: 40ed6d66d2b42437c3f9b6ebed0cf63bfda4e3b6 Author: simonmicro Date: 2024-05-19T13:16:43Z Files changed: src/services/OswServiceTaskConsole.cpp Patch: @@ -0,0 +1,187 @@ +#include "./services/OswServiceTaskConsole.h" +#include "osw_hal.h" + +void OswServiceTaskConsole::setup() { + OswServiceTask::setup(); + OSW_LOG_I("Console is now enabled."); +#ifdef NDEBUG + this-&gt; m_locked = true; // in release mode the console is locked by default +#endif + this-&gt;newPrompt(); +} + +void OswServiceTaskConsole::loop() { + while(true) { + if(!Serial.available()) break; + char c = Serial.read(); + switch (c) { + case 10: // LF + case 13: // CR + this-&gt;runPrompt(); + this-&gt;newPrompt(); + break; + case 8: // backspace + case 127: // delete + case 27: // escape + if(this-&gt;m_inputBuffer.length() &gt; 0) { + this-&gt;m_inputBuffer.pop_back(); + } + Serial.print(c); + break; + case 9: // tab + Serial.println(); // finish the prompt line + this-&gt;showHelp(); + this-&gt;showPrompt(); + break; + default: + if(32 &lt;= c and c &lt;= 126) { // printable characters + this-&gt;m_inputBuffer += c; + Serial.print(c); // echo the entered character back + } else { + Serial.print((char) 0x07); // bell + OSW_LOG_D("Unprocessable character (",(int) c, "): ", c); + } + } + } +} + +void OswServiceTaskConsole::newPrompt() { + this-&gt;m_inputBuffer.clear(); + if(this-&gt;m_locked) return; + this-&gt;showPrompt(); +} + +void OswServiceTaskConsole::showPrompt() { + if (this-&gt;m_configuring) { + Serial.print("OSW (configure) &gt; "); + } else { + Serial.print("OSW &gt; "); + } + if(!this-&gt;m_inputBuffer.empty()) { + Serial.print(this-&gt;m_inputBuffer.c_str()); + } +} + +void OswServiceTaskConsole::runPrompt() { + Serial.println(); // finish the prompt line + if(this-&gt;m_inputBuffer.empty()) return; + if(this-&gt;m_locked) { + Serial.println("Console is locked! Enter \"unlock\" to unlock."); + if(this-&gt;m_inputBuffer == "unlock") { + this-&gt;m_locked = false; + } + return; + } + // command convention: show only what was asked (preferably machine readable), only on error be verbose + bool processed = true; + if (this-&gt;m_configuring) { + if (this-&gt;m_inputBuffer == "clear") { + OswConfig::getInstance()-&gt;reset(false); + } else if (this-&gt;m_inputBuffer == "exit") { + this-&gt;m_configuring = false; + } else if (this-&gt;m_inputBuffer.find("get ") == 0 and this-&gt;m_inputBuffer.length() &gt; 4) { + auto key = this-&gt;m_inputBuffer.substr(4); + for (auto i = 0; i &lt; oswConfigKeysCount; i++) { + if(oswConfigKeys[i]-&gt;id == key) { + Serial.println(oswConfigKeys[i]-&gt;toString()); + break; + } + } + } else if (this-&gt;m_inputBuffer.find("info ") == 0 and this-&gt;m_inputBuffer.length() &gt; 5) { + auto key = this-&gt;m_inputBuffer.substr(5); + Serial.println(OswConfig::getInstance()-&gt;getFieldJson(key.c_str())); + } else if (this-&gt;m_inputBuffer == "help") { + this-&gt;showHelp(); + } else if (this-&gt;m_inputBuffer == "list") { + for (auto i = 0; i &lt; oswConfigKeysCount; i++) { + Serial.println(oswConfigKeys[i]-&gt;id); + } + } else if (this-&gt;m_inputBuffer.find("reset ") == 0 and this-&gt;m_inputBuffer.length() &gt; 7) { + auto key = this-&gt;m_inputBuffer.substr(7); + OswConfig::getInstance()-&gt;enableWrite(); + OswConfig::getInstance()-&gt;resetField(key.c_str()); + OswConfig::getInstance()-&gt;disableWrite(); + } else if (this-&gt;m_inputBuffer.find("set ") == 0 and this-&gt;m_inputBuffer.length() &gt; 5) { + auto key = this-&gt;m_inputBuffer.substr(4); // "<id> <value>" + auto space = key.find(" ", 0); + if (space == std::string::npos) { + Serial.println("Invalid command."); + return; + } + auto value = key.substr(space + 1); // "<value>" + key = key.substr(0, space); // "<id>" + OswConfig::getInstance()-&gt;enableWrite(); + OswConfig::getInstance()-&gt;setField(key.c_str(), value.c_str()); + OswConfig::getInstance()-&gt;disableWrite(); + } else { + processed = false; + } + } else { + if (this-&gt;m_inputBuffer == "configure") { + this-&gt;m_configuring = true; + } else if (this-&gt;m_inputBuffer == "help") { + this-&gt;showHelp(); +#ifdef OSW_FEATURE_WIFI + } else if (this-&gt;m_inputBuffer == "hostname") { + Serial.println(OswConfigAllKeys::hostname.get()); +#endif + } else if (this-&gt;m_inputBuffer == "lock") { + this-&gt;m_locked = true; +#ifndef OSW_EMULATOR + } else if (this-&gt;m_inputBuffer == "reboot") { + // this does not work in the emulator as it is running under an own thread, of which the shutdown-exception is not captured - populating here and crashing + ESP.restart(); +#endif + } else if (this-&gt;m_inputBuffer == "time") { + Serial.println(OswHal::getInstance()-&gt;getUTCTime()); + } else if (this-&gt;m_inputBuffer == "wipe") { + OswConfig::getInstance()-&gt;reset(true); + } else { + processed = false; + } + } + // show help if the command was not processed + if (!processed) { + Serial.println("Unknown command."); + Serial.println(); + this-&gt;showHelp(); + this-&gt;m_lockCounter++; + } + // in case of garbage input, lock the console after 16 attempts + if (this-&gt;m_lockCounter &gt; 16) { + this-&gt;m_locked = true; + this-&gt;m_lockCounter = 0; + } +} + +void OswServiceTaskConsole::showHelp() { + Serial.println("Available commands:"); + // let's try to be civil and show the commands in alphabetical order + if (this-&gt;m_configuring) { + Serial.println(" clear - reset all keys to default values"); + Serial.println(" exit - leave configuration mode"); + Serial.println(" get <id> - get a value for a key"); + Serial.println(" help - show this help"); + Serial.println(" info <id> - show more information about a key"); + Serial.println(" list - show all keys"); + Serial.println(" reset <id> - reset a key to default value"); + Serial.println(" set <id> <value> - set a value for a key (value is everything until the end of the line)"); + } else { + Serial.println(" configure - enter configuration mode"); + Serial.println(" help - show this help"); +#ifdef OSW_FEATURE_WIFI + Serial.println(" hostname - show the device hostname"); +#endif + Serial.println(" lock - lock the console"); +#ifndef OSW_EMULATOR + Serial.println(" reboot - warm-start the device forcefully"); +#endif + Serial.println(" time - show current UTC time"); + Serial.println(" wipe - format NVS partition and reset configuration"); + } +} + +void OswServiceTaskConsole::stop() { + OSW_LOG_I("Console is now disabled."); + OswServiceTask::stop(); +} \ No newline at end of file Commit SHA: 40ed6d66d2b42437c3f9b6ebed0cf63bfda4e3b6 Author: simonmicro Date: 2024-05-19T13:16:43Z Files changed: src/services/OswServiceTaskExample.cpp Patch: @@ -1,6 +1,5 @@ -#include "./services/OswServiceTaskExample.h" #include "osw_hal.h" -#include <time.h> +#include "./services/OswServiceTaskExample.h" void OswServiceTaskExample::setup() { OswServiceTask::setup(); @@ -16,6 +15,6 @@ void OswServiceTaskExample::loop() { } void OswServiceTaskExample::stop() { - OswServiceTask::stop(); OSW_LOG_I(__FUNCTION__, "()"); -} \ No newline at end of file + OswServiceTask::stop(); +} Commit SHA: 40ed6d66d2b42437c3f9b6ebed0cf63bfda4e3b6 Author: simonmicro Date: 2024-05-19T13:16:43Z Files changed: src/services/OswServiceTaskWebserver.cpp Patch: @@ -297,8 +297,8 @@ void OswServiceTaskWebserver::loop() { } void OswServiceTaskWebserver::stop() { - OswServiceTask::stop(); this-&gt;disableWebserver(); //Make sure the webserver is also stopped + OswServiceTask::stop(); } void OswServiceTaskWebserver::enableWebserver() { Commit SHA: 40ed6d66d2b42437c3f9b6ebed0cf63bfda4e3b6 Author: simonmicro Date: 2024-05-19T13:16:43Z Files changed: src/services/OswServiceTaskWiFi.cpp Patch: @@ -137,8 +137,8 @@ void OswServiceTaskWiFi::selectCredentials() { } void OswServiceTaskWiFi::stop() { - OswServiceTask::stop(); this-&gt;disableWiFi(); + OswServiceTask::stop(); } /** Commit SHA: 40ed6d66d2b42437c3f9b6ebed0cf63bfda4e3b6 Author: simonmicro Date: 2024-05-19T13:16:43Z Files changed: src/services/OswServiceTasks.cpp Patch: @@ -5,13 +5,17 @@ #include "services/OswServiceTaskGPS.h" #include "services/OswServiceTaskMemMonitor.h" #include "services/OswServiceTaskNotifier.h" +#include "services/OswServiceTaskConsole.h" #ifdef OSW_FEATURE_WIFI #include "services/OswServiceTaskWiFi.h" #include "services/OswServiceTaskWebserver.h" #endif #include "osw_util.h" namespace OswServiceAllTasks { +#ifdef OSW_SERVICE_EXAMPLE +OswServiceTaskExample example; +#endif // OswServiceTaskExample example; #if SERVICE_BLE_COMPANION == 1 OswServiceTaskBLECompanion bleCompanion; @@ -30,6 +34,9 @@ OswServiceTaskNotifier notifier; #ifndef OSW_EMULATOR OswServiceTaskMemMonitor memory; #endif +#ifdef OSW_SERVICE_CONSOLE +OswServiceTaskConsole console; +#endif } // namespace OswServiceAllTasks OswServiceTask* oswServiceTasks[] = { @@ -40,13 +47,18 @@ OswServiceTask* oswServiceTasks[] = { &amp; OswServiceAllTasks::gps, #endif -//&amp;OswServiceAllTasks::example, +#ifdef OSW_SERVICE_EXAMPLE + &amp; OswServiceAllTasks::example, +#endif #ifdef OSW_FEATURE_WIFI &amp; OswServiceAllTasks::wifi, &amp;OswServiceAllTasks::webserver, #endif #if OSW_SERVICE_NOTIFIER == 1 &amp; OswServiceAllTasks::notifier, #endif +#ifdef OSW_SERVICE_CONSOLE + &amp; OswServiceAllTasks::console, +#endif #ifndef OSW_EMULATOR #ifndef NDEBUG &amp; OswServiceAllTasks::memory Commit SHA: 534bd63f9b708b115a46554949a7a3be4ace6c31 Author: simonmicro Date: 2024-05-19T12:55:14Z Files changed: lib/open-smartwatch-web Patch: @@ -1 +1 @@ -Subproject commit df4e89fcbf0e4eaf9d34d3bc6f6269d26d21f88d +Subproject commit 7e59541511c93f664d9ded8db499cb8a7a09df39 Commit SHA: 173e567a7b47bd2c628261bc3cb25e9d6af07ce9 Author: simonmicro Date: 2024-05-19T12:48:09Z Files changed: src/apps/tools/OswAppFlashLight.cpp Patch: @@ -31,20 +31,22 @@ void OswAppFlashLight::onStart() { void OswAppFlashLight::onDraw() { OswAppV2::onDraw(); + const uint16_t whiteColor = rgb888to565(rgb888(255, 255, 255)); + const uint16_t blackColor = rgb888to565(rgb888(0, 0, 0)); this-&gt;hal-&gt;gfx()-&gt;fillCircle(120, 120, 120, ui-&gt;getSuccessColor()); if (this-&gt;on) { - this-&gt;hal-&gt;gfx()-&gt;fillCircle(120, 120, 115, ui-&gt;getForegroundColor()); + this-&gt;hal-&gt;gfx()-&gt;fillCircle(120, 120, 115, whiteColor); this-&gt;hal-&gt;gfx()-&gt;setTextSize(3); this-&gt;hal-&gt;gfx()-&gt;setTextCenterAligned(); this-&gt;hal-&gt;gfx()-&gt;setTextCursor(120, 125); - this-&gt;hal-&gt;gfx()-&gt;setTextColor(ui-&gt;getBackgroundColor()); + this-&gt;hal-&gt;gfx()-&gt;setTextColor(blackColor); this-&gt;hal-&gt;gfx()-&gt;print(int(hal-&gt;screenBrightness())); //displays the current brightness } else { - this-&gt;hal-&gt;gfx()-&gt;fillCircle(120, 120, 115, ui-&gt;getBackgroundColor()); + this-&gt;hal-&gt;gfx()-&gt;fillCircle(120, 120, 115, blackColor); this-&gt;hal-&gt;gfx()-&gt;setTextSize(3.5); this-&gt;hal-&gt;gfx()-&gt;setTextCenterAligned(); this-&gt;hal-&gt;gfx()-&gt;setTextCursor(120, 125); - this-&gt;hal-&gt;gfx()-&gt;setTextColor(ui-&gt;getForegroundColor()); + this-&gt;hal-&gt;gfx()-&gt;setTextColor(whiteColor); this-&gt;hal-&gt;gfx()-&gt;print("Flashlight"); } } Commit SHA: 5e51ce4ec30215d7b9dff21e5e1eb16a137501a7 Author: Ruffalo Lavoisier Date: 2024-05-19T12:30:15Z Files changed: src/apps/tools/OswAppFlashLight.cpp Patch: @@ -31,20 +31,22 @@ void OswAppFlashLight::onStart() { void OswAppFlashLight::onDraw() { OswAppV2::onDraw(); + const uint16_t whiteColor = rgb888to565(rgb888(255, 255, 255)); + const uint16_t blackColor = rgb888to565(rgb888(0, 0, 0)); this-&gt;hal-&gt;gfx()-&gt;fillCircle(120, 120, 120, ui-&gt;getSuccessColor()); if (this-&gt;on) { - this-&gt;hal-&gt;gfx()-&gt;fillCircle(120, 120, 115, ui-&gt;getForegroundColor()); + this-&gt;hal-&gt;gfx()-&gt;fillCircle(120, 120, 115, whiteColor); this-&gt;hal-&gt;gfx()-&gt;setTextSize(3); this-&gt;hal-&gt;gfx()-&gt;setTextCenterAligned(); this-&gt;hal-&gt;gfx()-&gt;setTextCursor(120, 125); - this-&gt;hal-&gt;gfx()-&gt;setTextColor(ui-&gt;getBackgroundColor()); + this-&gt;hal-&gt;gfx()-&gt;setTextColor(blackColor); this-&gt;hal-&gt;gfx()-&gt;print(int(hal-&gt;screenBrightness())); //displays the current brightness } else { - this-&gt;hal-&gt;gfx()-&gt;fillCircle(120, 120, 115, ui-&gt;getBackgroundColor()); + this-&gt;hal-&gt;gfx()-&gt;fillCircle(120, 120, 115, blackColor); this-&gt;hal-&gt;gfx()-&gt;setTextSize(3.5); this-&gt;hal-&gt;gfx()-&gt;setTextCenterAligned(); this-&gt;hal-&gt;gfx()-&gt;setTextCursor(120, 125); - this-&gt;hal-&gt;gfx()-&gt;setTextColor(ui-&gt;getForegroundColor()); + this-&gt;hal-&gt;gfx()-&gt;setTextColor(whiteColor); this-&gt;hal-&gt;gfx()-&gt;print("Flashlight"); } } Commit SHA: 5004a75401667d05018fe0b5cf0d2cb7451f0e9d Author: simonmicro Date: 2024-05-19T12:02:17Z Files changed: .github/workflows/astyle.yml Patch: @@ -12,8 +12,10 @@ jobs: runs-on: ubuntu-latest if: $ steps: - - uses: actions/checkout@v1 + - name: Checkout repository and submodules + uses: nschloe/action-cached-lfs-checkout@v1 with: + # submodules: recursive # do not access any submodules to not accidentially modify them ref: $ - name: astyle uses: addnab/docker-run-action@v3 Commit SHA: 5004a75401667d05018fe0b5cf0d2cb7451f0e9d Author: simonmicro Date: 2024-05-19T12:02:17Z Files changed: .github/workflows/test-EMULATOR.yml Patch: @@ -13,8 +13,9 @@ jobs: should_skip: $ steps: - id: skip_check - uses: fkirc/skip-duplicate-actions@v5.2.0 + uses: fkirc/skip-duplicate-actions@v5 with: + cancel_others: "true" # in a PR with two runs (push+merge), the latter will cancel the first and run instead concurrent_skipping: "same_content_newer" skip_after_successful_duplicate: "true" @@ -34,7 +35,7 @@ jobs: # submodules: recursive # lfs: 'true' - name: Checkout repository and submodules - uses: nschloe/action-cached-lfs-checkout@v1.2.1 + uses: nschloe/action-cached-lfs-checkout@v1 with: submodules: recursive - name: Update packages Commit SHA: 5004a75401667d05018fe0b5cf0d2cb7451f0e9d Author: simonmicro Date: 2024-05-19T12:02:17Z Files changed: .github/workflows/test-FEATURE.yml Patch: @@ -13,8 +13,9 @@ jobs: should_skip: $ steps: - id: skip_check - uses: fkirc/skip-duplicate-actions@v5.2.0 + uses: fkirc/skip-duplicate-actions@v5 with: + cancel_others: "true" # in a PR with two runs (push+merge), the latter will cancel the first and run instead concurrent_skipping: "same_content_newer" skip_after_successful_duplicate: "true" @@ -24,7 +25,7 @@ jobs: if: $ steps: - name: Checkout repository and submodules - uses: nschloe/action-cached-lfs-checkout@v1.2.1 + uses: nschloe/action-cached-lfs-checkout@v1 with: submodules: recursive - id: get-flag @@ -51,23 +52,23 @@ jobs: language: $ steps: - name: Checkout repository and submodules - uses: nschloe/action-cached-lfs-checkout@v1.2.1 + uses: nschloe/action-cached-lfs-checkout@v1 with: submodules: recursive - name: Cache pip - uses: actions/cache@v3 + uses: actions/cache@v4 with: path: ~/.cache/pip key: pip-$ - name: Cache PlatformIO - uses: actions/cache@v3 + uses: actions/cache@v4 with: path: ~/.platformio key: platformio-$ - name: Install swig run: sudo apt-get update &amp;&amp; sudo apt-get -y install swig - name: Set up Python - uses: actions/setup-python@v4 + uses: actions/setup-python@v5 with: python-version: "3.10" - name: Install PlatformIO Commit SHA: 5004a75401667d05018fe0b5cf0d2cb7451f0e9d Author: simonmicro Date: 2024-05-19T12:02:17Z Files changed: .github/workflows/test-OS.yml Patch: @@ -11,10 +11,10 @@ jobs: runs-on: ubuntu-latest steps: - name: Checkout repository and submodules - uses: nschloe/action-cached-lfs-checkout@v1.2.1 + uses: nschloe/action-cached-lfs-checkout@v1 with: submodules: recursive - - uses: dorny/paths-filter@v2.11.1 + - uses: dorny/paths-filter@v3 id: filter with: filters: | @@ -44,31 +44,34 @@ jobs: language: $ steps: - name: Checkout repository and submodules - uses: nschloe/action-cached-lfs-checkout@v1.2.1 + uses: nschloe/action-cached-lfs-checkout@v1 with: submodules: recursive - name: Cache pip - uses: actions/cache@v3 + uses: actions/cache@v4 with: path: ~/.cache/pip key: pip-$ - name: Cache PlatformIO - uses: actions/cache@v3 + uses: actions/cache@v4 with: path: ~/.platformio key: platformio-$ + + - name: Install swig on Linux + if: matrix.os == 'ubuntu-latest' + run: sudo apt-get update &amp;&amp; sudo apt-get -y install swig + - name: Install swig on Mac OS + if: matrix.os == 'macos-latest' + run: brew install swig + - name: Set up Python - uses: actions/setup-python@v4 + uses: actions/setup-python@v5 with: python-version: "3.10" - - name: Install PlatformIO - shell: bash - run: | - apt update &amp;&amp; apt -y install swig - python -m pip install --upgrade pip - pip install --upgrade platformio - mv include/config.h.example include/config.h - + run: python -m pip install --upgrade pip &amp;&amp; pip install --upgrade platformio + - name: Rename config + run: mv include/config.h.example include/config.h - name: Compile language $ model $ run: python3 .github/buildFirmware.py -l "$" -m "$" -b debug Commit SHA: 5004a75401667d05018fe0b5cf0d2cb7451f0e9d Author: simonmicro Date: 2024-05-19T12:02:17Z Files changed: .github/workflows/test-OSW.yml Patch: @@ -14,8 +14,9 @@ jobs: should_skip: $ steps: - id: skip_check - uses: fkirc/skip-duplicate-actions@v5.2.0 + uses: fkirc/skip-duplicate-actions@v5 with: + cancel_others: "true" # in a PR with two runs (push+merge), the latter will cancel the first and run instead concurrent_skipping: "same_content_newer" skip_after_successful_duplicate: "true" @@ -25,10 +26,10 @@ jobs: if: $ steps: - name: Checkout repository and submodules - uses: nschloe/action-cached-lfs-checkout@v1.2.1 + uses: nschloe/action-cached-lfs-checkout@v1 with: submodules: recursive - - uses: dorny/paths-filter@v2.11.1 + - uses: dorny/paths-filter@v3 id: filter with: filters: | @@ -46,6 +47,7 @@ jobs: outputs: languages_matrix: $ models_matrix: $ + build-OSW: needs: Find-packages runs-on: ubuntu-latest @@ -57,23 +59,23 @@ jobs: build-configuration: [debug, release] steps: - name: Checkout repository and submodules - uses: nschloe/action-cached-lfs-checkout@v1.2.1 + uses: nschloe/action-cached-lfs-checkout@v1 with: submodules: recursive - name: Cache pip - uses: actions/cache@v3 + uses: actions/cache@v4 with: path: ~/.cache/pip key: pip-$ - name: Cache PlatformIO - uses: actions/cache@v3 + uses: actions/cache@v4 with: path: ~/.platformio key: platformio-$ - name: Install swig run: sudo apt-get update &amp;&amp; sudo apt-get -y install swig - name: Set up Python - uses: actions/setup-python@v4 + uses: actions/setup-python@v5 with: python-version: "3.10" - name: Install PlatformIO Commit SHA: bb9ac214581560e6b9c031bb799cc64b57be0243 Author: simonmicro Date: 2024-05-19T11:54:19Z Files changed: .github/workflows/test-EMULATOR.yml Patch: @@ -15,7 +15,7 @@ jobs: - id: skip_check uses: fkirc/skip-duplicate-actions@v5 with: - cancel_others: "true" # in a PR with two runs (puch+merge), the latter will cancel the first and run instead + cancel_others: "true" # in a PR with two runs (push+merge), the latter will cancel the first and run instead concurrent_skipping: "same_content_newer" skip_after_successful_duplicate: "true" Commit SHA: bb9ac214581560e6b9c031bb799cc64b57be0243 Author: simonmicro Date: 2024-05-19T11:54:19Z Files changed: .github/workflows/test-FEATURE.yml Patch: @@ -15,7 +15,7 @@ jobs: - id: skip_check uses: fkirc/skip-duplicate-actions@v5 with: - cancel_others: "true" # in a PR with two runs (puch+merge), the latter will cancel the first and run instead + cancel_others: "true" # in a PR with two runs (push+merge), the latter will cancel the first and run instead concurrent_skipping: "same_content_newer" skip_after_successful_duplicate: "true" Commit SHA: bb9ac214581560e6b9c031bb799cc64b57be0243 Author: simonmicro Date: 2024-05-19T11:54:19Z Files changed: .github/workflows/test-OSW.yml Patch: @@ -16,7 +16,7 @@ jobs: - id: skip_check uses: fkirc/skip-duplicate-actions@v5 with: - cancel_others: "true" # in a PR with two runs (puch+merge), the latter will cancel the first and run instead + cancel_others: "true" # in a PR with two runs (push+merge), the latter will cancel the first and run instead concurrent_skipping: "same_content_newer" skip_after_successful_duplicate: "true" Commit SHA: 4f848048f03bf0ec323a4456d3719451573c5f4b Author: simonmicro Date: 2024-05-19T10:15:56Z Files changed: .github/workflows/astyle.yml Patch: @@ -12,8 +12,10 @@ jobs: runs-on: ubuntu-latest if: $ steps: - - uses: actions/checkout@v1 + - name: Checkout repository and submodules + uses: nschloe/action-cached-lfs-checkout@v1 with: + # submodules: recursive # do not access any submodules to not accidentially modify them ref: $ - name: astyle uses: addnab/docker-run-action@v3 Commit SHA: 4f848048f03bf0ec323a4456d3719451573c5f4b Author: simonmicro Date: 2024-05-19T10:15:56Z Files changed: .github/workflows/test-EMULATOR.yml Patch: @@ -13,7 +13,7 @@ jobs: should_skip: $ steps: - id: skip_check - uses: fkirc/skip-duplicate-actions@v5.3.1 + uses: fkirc/skip-duplicate-actions@v5 with: cancel_others: "true" # in a PR with two runs (puch+merge), the latter will cancel the first and run instead concurrent_skipping: "same_content_newer" @@ -35,7 +35,7 @@ jobs: # submodules: recursive # lfs: 'true' - name: Checkout repository and submodules - uses: nschloe/action-cached-lfs-checkout@v1.2.1 + uses: nschloe/action-cached-lfs-checkout@v1 with: submodules: recursive - name: Update packages Commit SHA: 4f848048f03bf0ec323a4456d3719451573c5f4b Author: simonmicro Date: 2024-05-19T10:15:56Z Files changed: .github/workflows/test-FEATURE.yml Patch: @@ -13,7 +13,7 @@ jobs: should_skip: $ steps: - id: skip_check - uses: fkirc/skip-duplicate-actions@v5.3.1 + uses: fkirc/skip-duplicate-actions@v5 with: cancel_others: "true" # in a PR with two runs (puch+merge), the latter will cancel the first and run instead concurrent_skipping: "same_content_newer" @@ -25,7 +25,7 @@ jobs: if: $ steps: - name: Checkout repository and submodules - uses: nschloe/action-cached-lfs-checkout@v1.2.1 + uses: nschloe/action-cached-lfs-checkout@v1 with: submodules: recursive - id: get-flag @@ -52,23 +52,23 @@ jobs: language: $ steps: - name: Checkout repository and submodules - uses: nschloe/action-cached-lfs-checkout@v1.2.1 + uses: nschloe/action-cached-lfs-checkout@v1 with: submodules: recursive - name: Cache pip - uses: actions/cache@v3 + uses: actions/cache@v4 with: path: ~/.cache/pip key: pip-$ - name: Cache PlatformIO - uses: actions/cache@v3 + uses: actions/cache@v4 with: path: ~/.platformio key: platformio-$ - name: Install swig run: sudo apt-get update &amp;&amp; sudo apt-get -y install swig - name: Set up Python - uses: actions/setup-python@v4 + uses: actions/setup-python@v5 with: python-version: "3.10" - name: Install PlatformIO Commit SHA: 4f848048f03bf0ec323a4456d3719451573c5f4b Author: simonmicro Date: 2024-05-19T10:15:56Z Files changed: .github/workflows/test-OS.yml Patch: @@ -11,10 +11,10 @@ jobs: runs-on: ubuntu-latest steps: - name: Checkout repository and submodules - uses: nschloe/action-cached-lfs-checkout@v1.2.1 + uses: nschloe/action-cached-lfs-checkout@v1 with: submodules: recursive - - uses: dorny/paths-filter@v2.11.1 + - uses: dorny/paths-filter@v3 id: filter with: filters: | @@ -44,16 +44,16 @@ jobs: language: $ steps: - name: Checkout repository and submodules - uses: nschloe/action-cached-lfs-checkout@v1.2.1 + uses: nschloe/action-cached-lfs-checkout@v1 with: submodules: recursive - name: Cache pip - uses: actions/cache@v3 + uses: actions/cache@v4 with: path: ~/.cache/pip key: pip-$ - name: Cache PlatformIO - uses: actions/cache@v3 + uses: actions/cache@v4 with: path: ~/.platformio key: platformio-$ @@ -66,7 +66,7 @@ jobs: run: brew install swig - name: Set up Python - uses: actions/setup-python@v4 + uses: actions/setup-python@v5 with: python-version: "3.10" - name: Install PlatformIO Commit SHA: 4f848048f03bf0ec323a4456d3719451573c5f4b Author: simonmicro Date: 2024-05-19T10:15:56Z Files changed: .github/workflows/test-OSW.yml Patch: @@ -14,7 +14,7 @@ jobs: should_skip: $ steps: - id: skip_check - uses: fkirc/skip-duplicate-actions@v5.3.1 + uses: fkirc/skip-duplicate-actions@v5 with: cancel_others: "true" # in a PR with two runs (puch+merge), the latter will cancel the first and run instead concurrent_skipping: "same_content_newer" @@ -26,10 +26,10 @@ jobs: if: $ steps: - name: Checkout repository and submodules - uses: nschloe/action-cached-lfs-checkout@v1.2.1 + uses: nschloe/action-cached-lfs-checkout@v1 with: submodules: recursive - - uses: dorny/paths-filter@v2.11.1 + - uses: dorny/paths-filter@v3 id: filter with: filters: | @@ -59,23 +59,23 @@ jobs: build-configuration: [debug, release] steps: - name: Checkout repository and submodules - uses: nschloe/action-cached-lfs-checkout@v1.2.1 + uses: nschloe/action-cached-lfs-checkout@v1 with: submodules: recursive - name: Cache pip - uses: actions/cache@v3 + uses: actions/cache@v4 with: path: ~/.cache/pip key: pip-$ - name: Cache PlatformIO - uses: actions/cache@v3 + uses: actions/cache@v4 with: path: ~/.platformio key: platformio-$ - name: Install swig run: sudo apt-get update &amp;&amp; sudo apt-get -y install swig - name: Set up Python - uses: actions/setup-python@v4 + uses: actions/setup-python@v5 with: python-version: "3.10" - name: Install PlatformIO Commit SHA: 5d4a1a34aa7ff7d85c9a8f793dded330c227fe46 Author: simonmicro Date: 2024-05-19T10:01:27Z Files changed: .github/workflows/test-EMULATOR.yml Patch: @@ -13,8 +13,9 @@ jobs: should_skip: $ steps: - id: skip_check - uses: fkirc/skip-duplicate-actions@v5.2.0 + uses: fkirc/skip-duplicate-actions@v5.3.1 with: + cancel_others: "true" # in a PR with two runs (puch+merge), the latter will cancel the first and run instead concurrent_skipping: "same_content_newer" skip_after_successful_duplicate: "true" Commit SHA: 5d4a1a34aa7ff7d85c9a8f793dded330c227fe46 Author: simonmicro Date: 2024-05-19T10:01:27Z Files changed: .github/workflows/test-FEATURE.yml Patch: @@ -13,8 +13,9 @@ jobs: should_skip: $ steps: - id: skip_check - uses: fkirc/skip-duplicate-actions@v5.2.0 + uses: fkirc/skip-duplicate-actions@v5.3.1 with: + cancel_others: "true" # in a PR with two runs (puch+merge), the latter will cancel the first and run instead concurrent_skipping: "same_content_newer" skip_after_successful_duplicate: "true" Commit SHA: 5d4a1a34aa7ff7d85c9a8f793dded330c227fe46 Author: simonmicro Date: 2024-05-19T10:01:27Z Files changed: .github/workflows/test-OSW.yml Patch: @@ -14,8 +14,9 @@ jobs: should_skip: $ steps: - id: skip_check - uses: fkirc/skip-duplicate-actions@v5.2.0 + uses: fkirc/skip-duplicate-actions@v5.3.1 with: + cancel_others: "true" # in a PR with two runs (puch+merge), the latter will cancel the first and run instead concurrent_skipping: "same_content_newer" skip_after_successful_duplicate: "true" Commit SHA: ac4163e795c9e692affb63488ed2f9ce37a27bb4 Author: simonmicro Date: 2024-05-19T09:46:51Z Files changed: .github/workflows/test-OS.yml Patch: @@ -57,18 +57,21 @@ jobs: with: path: ~/.platformio key: platformio-$ + + - name: Install swig on Linux + if: matrix.os == 'ubuntu-latest' + run: sudo apt-get update &amp;&amp; sudo apt-get -y install swig + - name: Install swig on Mac OS + if: matrix.os == 'macos-latest' + run: brew install swig + - name: Set up Python uses: actions/setup-python@v4 with: python-version: "3.10" - - name: Install PlatformIO - shell: bash - run: | - apt update &amp;&amp; apt -y install swig - python -m pip install --upgrade pip - pip install --upgrade platformio - mv include/config.h.example include/config.h - + run: python -m pip install --upgrade pip &amp;&amp; pip install --upgrade platformio + - name: Rename config + run: mv include/config.h.example include/config.h - name: Compile language $ model $ run: python3 .github/buildFirmware.py -l "$" -m "$" -b debug Commit SHA: ac4163e795c9e692affb63488ed2f9ce37a27bb4 Author: simonmicro Date: 2024-05-19T09:46:51Z Files changed: .github/workflows/test-OSW.yml Patch: @@ -46,6 +46,7 @@ jobs: outputs: languages_matrix: $ models_matrix: $ + build-OSW: needs: Find-packages runs-on: ubuntu-latest Commit SHA: 0607210a1ff0dacd2652a97b9af48df3e539da79 Author: simonmicro Date: 2024-04-13T08:44:32Z Files changed: .github/workflows/test-EMULATOR.yml Patch: @@ -2,9 +2,9 @@ name: Build OSW Emulator (Ubuntu) on: push: - paths_ignore: '["**/*.md", "**/scripts/screen_capture/**"]' + paths-ignore: ["**/*.md", "**/scripts/screen_capture/**"] pull_request: - branches: [ master, develop ] + branches: [master, develop] jobs: check_skip: @@ -15,8 +15,8 @@ jobs: - id: skip_check uses: fkirc/skip-duplicate-actions@v5.2.0 with: - concurrent_skipping: 'same_content_newer' - skip_after_successful_duplicate: 'true' + concurrent_skipping: "same_content_newer" + skip_after_successful_duplicate: "true" build-EMULATOR: runs-on: ubuntu-22.04 @@ -25,24 +25,36 @@ jobs: strategy: matrix: build-configuration: [Debug, Release] - steps: - - name: Checkout repository and submodules - # uses: actions/checkout@v3 # incompatible with git lfs cache bandwidth calcs (https://github.com/actions/checkout/issues/165) - uses: nschloe/action-cached-lfs-checkout@v1.2.1 - with: - submodules: recursive - lfs: 'true' - - name: Update packages - run: sudo apt-get update - - name: Install packages - run: sudo apt-get -y install gcc g++ cmake libsdl2-dev libsdl2-image-dev python3 python3-pip - - name: Install python packages - run: pip3 install --user -r scripts/requirements.txt - - name: Create build directory - run: mkdir build - - name: CMake $ - run: cd build &amp;&amp; cmake -DCMAKE_BUILD_TYPE=$ .. - - name: Make - run: cd build &amp;&amp; make -j $(nproc) - - name: Test - run: cd build &amp;&amp; make test + steps: + # the following is incompatible with git lfs cache bandwidth calculations (https://github.com/actions/checkout/issues/165) + # -&gt; we removed the following and replaced it with a cache-aware checkout + # - name: Checkout repository and submodules + # uses: actions/checkout@v3 + # with: + # submodules: recursive + # lfs: 'true' + - name: Checkout repository and submodules + uses: nschloe/action-cached-lfs-checkout@v1.2.1 + with: + submodules: recursive + - name: Update packages + run: sudo apt-get update + - name: Install packages + run: sudo apt-get -y install gcc g++ cmake libsdl2-dev libsdl2-image-dev python3 python3-pip + - name: Install python packages + run: pip3 install --user -r scripts/requirements.txt + - name: Create build directory + run: mkdir build + - name: CMake $ + run: cd build &amp;&amp; cmake -DCMAKE_BUILD_TYPE=$ .. + - name: Make + run: cd build &amp;&amp; make -j $(nproc) + - name: Test + run: cd build &amp;&amp; make test + - name: Upload test artifacts + if: failure() + uses: actions/upload-artifact@v4 + with: + name: test-results + path: | + build/Testing Commit SHA: 0607210a1ff0dacd2652a97b9af48df3e539da79 Author: simonmicro Date: 2024-04-13T08:44:32Z Files changed: .github/workflows/test-FEATURE.yml Patch: @@ -2,9 +2,9 @@ name: Build OSW-OS (Ubuntu, additional features) on: push: - paths_ignore: '["*.md", "**/scripts/screen_capture/**"]' + paths-ignore: ["*.md", "**/scripts/screen_capture/**"] pull_request: - branches: [ master, develop ] + branches: [master, develop] jobs: check_skip: @@ -15,20 +15,18 @@ jobs: - id: skip_check uses: fkirc/skip-duplicate-actions@v5.2.0 with: - concurrent_skipping: 'same_content_newer' - skip_after_successful_duplicate: 'true' + concurrent_skipping: "same_content_newer" + skip_after_successful_duplicate: "true" Find-feature: runs-on: ubuntu-latest needs: check_skip if: $ - steps: + steps: - name: Checkout repository and submodules - # uses: actions/checkout@v3 # incompatible with git lfs cache bandwidth calcs (https://github.com/actions/checkout/issues/165) uses: nschloe/action-cached-lfs-checkout@v1.2.1 with: submodules: recursive - lfs: 'true' - id: get-flag run: | echo "feature=$(python3 .github/getWorkflowMatrix.py all_flags)" &gt;&gt; $GITHUB_OUTPUT @@ -52,31 +50,29 @@ jobs: model: $ language: $ steps: - - name: Checkout repository and submodules - # uses: actions/checkout@v3 # incompatible with git lfs cache bandwidth calcs (https://github.com/actions/checkout/issues/165) - uses: nschloe/action-cached-lfs-checkout@v1.2.1 - with: - submodules: recursive - lfs: 'true' - - name: Cache pip - uses: actions/cache@v3 - with: - path: ~/.cache/pip - key: pip-$ - - name: Cache PlatformIO - uses: actions/cache@v3 - with: - path: ~/.platformio - key: platformio-$ - - name: Install swig - run: sudo apt-get update &amp;&amp; sudo apt-get -y install swig - - name: Set up Python - uses: actions/setup-python@v4 - with: - python-version: '3.10' - - name: Install PlatformIO - run: python -m pip install --upgrade pip &amp;&amp; pip install --upgrade platformio - - name: Rename config - run: mv include/config.h.example include/config.h - - name: Compile language $ model $ feature $ - run: python3 .github/buildFirmware.py -l "$" -m "$" -f "$" -b debug + - name: Checkout repository and submodules + uses: nschloe/action-cached-lfs-checkout@v1.2.1 + with: + submodules: recursive + - name: Cache pip + uses: actions/cache@v3 + with: + path: ~/.cache/pip + key: pip-$ + - name: Cache PlatformIO + uses: actions/cache@v3 + with: + path: ~/.platformio + key: platformio-$ + - name: Install swig + run: sudo apt-get update &amp;&amp; sudo apt-get -y install swig + - name: Set up Python + uses: actions/setup-python@v4 + with: + python-version: "3.10" + - name: Install PlatformIO + run: python -m pip install --upgrade pip &amp;&amp; pip install --upgrade platformio + - name: Rename config + run: mv include/config.h.example include/config.h + - name: Compile language $ model $ feature $ + run: python3 .github/buildFirmware.py -l "$" -m "$" -f "$" -b debug Commit SHA: 0607210a1ff0dacd2652a97b9af48df3e539da79 Author: simonmicro Date: 2024-04-13T08:44:32Z Files changed: .github/workflows/test-OS.yml Patch: @@ -4,18 +4,16 @@ on: workflow_dispatch: pull_request: schedule: - - cron: '0 0 * * *' + - cron: "0 0 * * *" jobs: Find-feature: runs-on: ubuntu-latest - steps: + steps: - name: Checkout repository and submodules - # uses: actions/checkout@v3 # incompatible with git lfs cache bandwidth calcs (https://github.com/actions/checkout/issues/165) uses: nschloe/action-cached-lfs-checkout@v1.2.1 with: submodules: recursive - lfs: 'true' - uses: dorny/paths-filter@v2.11.1 id: filter with: @@ -45,34 +43,32 @@ jobs: model: $ language: $ steps: - - name: Checkout repository and submodules - # uses: actions/checkout@v3 # incompatible with git lfs cache bandwidth calcs (https://github.com/actions/checkout/issues/165) - uses: nschloe/action-cached-lfs-checkout@v1.2.1 - with: - submodules: recursive - lfs: 'true' - - name: Cache pip - uses: actions/cache@v3 - with: - path: ~/.cache/pip - key: pip-$ - - name: Cache PlatformIO - uses: actions/cache@v3 - with: - path: ~/.platformio - key: platformio-$ - - name: Set up Python - uses: actions/setup-python@v4 - with: - python-version: '3.10' + - name: Checkout repository and submodules + uses: nschloe/action-cached-lfs-checkout@v1.2.1 + with: + submodules: recursive + - name: Cache pip + uses: actions/cache@v3 + with: + path: ~/.cache/pip + key: pip-$ + - name: Cache PlatformIO + uses: actions/cache@v3 + with: + path: ~/.platformio + key: platformio-$ + - name: Set up Python + uses: actions/setup-python@v4 + with: + python-version: "3.10" - - name: Install PlatformIO - shell: bash - run: | - apt update &amp;&amp; apt -y install swig - python -m pip install --upgrade pip - pip install --upgrade platformio - mv include/config.h.example include/config.h + - name: Install PlatformIO + shell: bash + run: | + apt update &amp;&amp; apt -y install swig + python -m pip install --upgrade pip + pip install --upgrade platformio + mv include/config.h.example include/config.h - - name: Compile language $ model $ - run: python3 .github/buildFirmware.py -l "$" -m "$" -b debug + - name: Compile language $ model $ + run: python3 .github/buildFirmware.py -l "$" -m "$" -b debug Commit SHA: 0607210a1ff0dacd2652a97b9af48df3e539da79 Author: simonmicro Date: 2024-04-13T08:44:32Z Files changed: .github/workflows/test-OSW.yml Patch: @@ -3,9 +3,9 @@ name: Build OSW-OS (Ubuntu, all models) on: workflow_dispatch: push: - paths_ignore: '["*.md", "**/scripts/screen_capture/**"]' + paths-ignore: ["*.md", "**/scripts/screen_capture/**"] pull_request: - branches: [ master, develop ] + branches: [master, develop] jobs: check_skip: @@ -16,20 +16,18 @@ jobs: - id: skip_check uses: fkirc/skip-duplicate-actions@v5.2.0 with: - concurrent_skipping: 'same_content_newer' - skip_after_successful_duplicate: 'true' + concurrent_skipping: "same_content_newer" + skip_after_successful_duplicate: "true" Find-packages: runs-on: ubuntu-latest needs: check_skip if: $ - steps: + steps: - name: Checkout repository and submodules - # uses: actions/checkout@v3 # incompatible with git lfs cache bandwidth calcs (https://github.com/actions/checkout/issues/165) uses: nschloe/action-cached-lfs-checkout@v1.2.1 with: submodules: recursive - lfs: 'true' - uses: dorny/paths-filter@v2.11.1 id: filter with: @@ -58,37 +56,35 @@ jobs: model: $ build-configuration: [debug, release] steps: - - name: Checkout repository and submodules - # uses: actions/checkout@v3 # incompatible with git lfs cache bandwidth calcs (https://github.com/actions/checkout/issues/165) - uses: nschloe/action-cached-lfs-checkout@v1.2.1 - with: - submodules: recursive - lfs: 'true' - - name: Cache pip - uses: actions/cache@v3 - with: - path: ~/.cache/pip - key: pip-$ - - name: Cache PlatformIO - uses: actions/cache@v3 - with: - path: ~/.platformio - key: platformio-$ - - name: Install swig - run: sudo apt-get update &amp;&amp; sudo apt-get -y install swig - - name: Set up Python - uses: actions/setup-python@v4 - with: - python-version: '3.10' - - name: Install PlatformIO - run: python -m pip install --upgrade pip &amp;&amp; pip install --upgrade platformio - - name: Rename config - run: mv include/config.h.example include/config.h - - name: Compile language $ model $ - run: python3 .github/buildFirmware.py -l "$" -m "$" -b "$" - - name: Upload firmware artifacts - uses: actions/upload-artifact@v3 - with: - name: firmwares - path: | - *.bin + - name: Checkout repository and submodules + uses: nschloe/action-cached-lfs-checkout@v1.2.1 + with: + submodules: recursive + - name: Cache pip + uses: actions/cache@v3 + with: + path: ~/.cache/pip + key: pip-$ + - name: Cache PlatformIO + uses: actions/cache@v3 + with: + path: ~/.platformio + key: platformio-$ + - name: Install swig + run: sudo apt-get update &amp;&amp; sudo apt-get -y install swig + - name: Set up Python + uses: actions/setup-python@v4 + with: + python-version: "3.10" + - name: Install PlatformIO + run: python -m pip install --upgrade pip &amp;&amp; pip install --upgrade platformio + - name: Rename config + run: mv include/config.h.example include/config.h + - name: Compile language $ model $ + run: python3 .github/buildFirmware.py -l "$" -m "$" -b "$" + - name: Upload firmware artifacts + uses: actions/upload-artifact@v3 + with: + name: firmwares + path: | + *.bin Commit SHA: 0607210a1ff0dacd2652a97b9af48df3e539da79 Author: simonmicro Date: 2024-04-13T08:44:32Z Files changed: CMakeLists.txt Patch: @@ -142,7 +142,8 @@ target_compile_definitions(emulator.run PUBLIC # Comment these as you wish... OSW_FEATURE_STATS_STEPS OSW_FEATURE_WEATHER - OSW_APPS_EXAMPLES=1 + OSW_SERVICE_CONSOLE + OSW_APPS_EXAMPLES GAME_SNAKE=1 GAME_BRICK_BREAKER=1 TOOL_FLASHLIGHT=1 Commit SHA: 0607210a1ff0dacd2652a97b9af48df3e539da79 Author: simonmicro Date: 2024-04-13T08:44:32Z Files changed: README.md Patch: @@ -51,14 +51,27 @@ If you want to compile for a specific model, you can use the `-e` flag with an ` ## Hack it! To get started, take a look into the examples in the `src/apps/examples` folder - or just into any other app. If you want to compile the examples or other (by default) excluded applications, take a look into the `main.cpp` file and add the respective flags to the `platformio.ini` file. -## Debugging (CLI) +## CLI If you want to print out the log for debugging (also including decoded exception traces), use the following command: ```bash $ pio device monitor ``` +In this serial console you also have the ability (beside much more) to configure the watch - just type in `help` to get started: +``` +OSW &gt; help +Available commands: + configure - enter configuration mode + help - show this help + hostname - show the device hostname + lock - lock the console + reboot - warm-start the device forcefully + time - show current UTC time + wipe - format NVS partition and reset configuration +``` + ## Creating Screenshots of your Apps<p align="center"> @@ -98,6 +111,7 @@ $ cd scripts/screen_capture/ $ ./createScreenshot.sh <IP_OF_WATCH> <SCREENSHOT> ``` * The captured file can be found in the `screenshot/` folder inside the `open-smartwatch-os` directory. + ## Troubleshooting For more information on troubleshooting, see [Wiki](https://open-smartwatch.github.io/resources/firmware/#troubleshooting). Commit SHA: 0607210a1ff0dacd2652a97b9af48df3e539da79 Author: simonmicro Date: 2024-04-13T08:44:32Z Files changed: docs/firmware/osw_os.md Patch: @@ -12,6 +12,15 @@ Flag | Description | Requirements `GPS_EDITION` | Configure the build for use with GPS (including apps, api, sensors) | `PROGMEM_TILES`, `BOARD_HAS_PSRAM` `GPS_EDITION_ROTATED` | Replacement for `GPS_EDITION` to work with flipped boards | - +## Example Flags + +You want to know how to use some example code or see it in action? These flags enable vairous features that are not enabled by default - just search inside the source code for the flag to see how it works and what it does. + +Flag | Description | Requirements +----------- | ----------- | ----------- +`OSW_SERVICE_EXAMPLE` | Enable the example code to demonstrate how to write on services. | - +`OSW_APPS_EXAMPLES` | Enable the example code to demonstrate how to write own apps (v1/v2). | - + ## Experimental Flags These flags should be available on all models. Because they are experimental, they are not enabled by default any may won't work or even compile. Commit SHA: 0607210a1ff0dacd2652a97b9af48df3e539da79 Author: simonmicro Date: 2024-04-13T08:44:32Z Files changed: emulator/include/Serial.h Patch: @@ -9,7 +9,7 @@ class Serial_t { public: - Serial_t() {}; + Serial_t(); ~Serial_t() {}; std::list&lt;std::stringstream&gt; buffer; @@ -40,8 +40,12 @@ class Serial_t { this-&gt;println(); } + int available(); + int read(); + void println(); private: + std::list<char> inputBuffer; int bauds = 0; bool buffered = false; bool addBufferNewline = true; Commit SHA: 0607210a1ff0dacd2652a97b9af48df3e539da79 Author: simonmicro Date: 2024-04-13T08:44:32Z Files changed: emulator/src/Serial.cpp Patch: @@ -1,8 +1,18 @@ #include "../include/Serial.h" #include <OswLogger.h> +#include <iostream> +#include <unistd.h> +#include <fcntl.h> + Serial_t Serial; +Serial_t::Serial_t() { + // put the stdin-stream into non-blocking mode to avoid hanging in case available() is called + int flags = fcntl(STDIN_FILENO, F_GETFL, 0); + fcntl(STDIN_FILENO, F_SETFL, flags | O_NONBLOCK); +} + void Serial_t::setBuffered(bool buffered) { this-&gt;buffered = buffered; this-&gt;addBufferNewline = true; @@ -26,4 +36,21 @@ void Serial_t::println() { this-&gt;addBufferNewline = true; else std::cout &lt;&lt; std::endl; +} + +int Serial_t::available() { + char c; + if(::read(STDIN_FILENO, &amp;c, 1) &gt; 0) { + this-&gt;inputBuffer.push_back(c); + return true; + } + return false; +} + +int Serial_t::read() { + if(this-&gt;inputBuffer.empty()) + return -1; + char c = this-&gt;inputBuffer.front(); + this-&gt;inputBuffer.pop_front(); + return c; } \ No newline at end of file Commit SHA: 0607210a1ff0dacd2652a97b9af48df3e539da79 Author: simonmicro Date: 2024-04-13T08:44:32Z Files changed: emulator/src/tests/unitTests/logging.cpp Patch: @@ -10,7 +10,7 @@ * be bound to the stack-frame of its test - and destroyed upon leaving. */ -#define EXPECT_LASTLINE(expect) EXPECT_STREQ(expect, Serial.buffer.back().str().c_str()) +#define EXPECT_LASTLINE(expect) EXPECT_STREQ(expect, (Serial.buffer.size() ? Serial.buffer.back().str().c_str() : "")) // Defines to use check log messages (all except debug!) #ifndef NDEBUG Commit SHA: 0607210a1ff0dacd2652a97b9af48df3e539da79 Author: simonmicro Date: 2024-04-13T08:44:32Z Files changed: include/osw_config.h Patch: @@ -47,6 +47,7 @@ class OswConfig { String getCategoriesJson(); String getFieldJson(String id); void setField(String id, String value); + void resetField(String id); void notifyChange(); protected: Preferences prefs; // for the config keys accessible Commit SHA: 0607210a1ff0dacd2652a97b9af48df3e539da79 Author: simonmicro Date: 2024-04-13T08:44:32Z Files changed: include/services/OswServiceTaskConsole.h Patch: @@ -0,0 +1,22 @@ +#pragma once +#include "osw_service.h" + +class OswServiceTaskConsole : public OswServiceTask { + public: + OswServiceTaskConsole() {}; + virtual void setup() override; + virtual void loop() override; + virtual void stop() override; + ~OswServiceTaskConsole() {}; + + private: + void newPrompt(); + void showPrompt(); + void runPrompt(); + void showHelp(); + + std::string m_inputBuffer; + bool m_locked = false; + unsigned char m_lockCounter = 0; + bool m_configuring = false; +}; \ No newline at end of file Commit SHA: 0607210a1ff0dacd2652a97b9af48df3e539da79 Author: simonmicro Date: 2024-04-13T08:44:32Z Files changed: include/services/OswServiceTaskExample.h Patch: @@ -1,6 +1,5 @@ -#ifndef OSW_SERVICE_TASKEXAMPLE_H -#define OSW_SERVICE_TASKEXAMPLE_H - +#pragma once +#include <time.h> #include "osw_service.h" class OswServiceTaskExample : public OswServiceTask { @@ -14,5 +13,3 @@ class OswServiceTaskExample : public OswServiceTask { private: time_t printLimit = 0; }; - -#endif \ No newline at end of file Commit SHA: 0607210a1ff0dacd2652a97b9af48df3e539da79 Author: simonmicro Date: 2024-04-13T08:44:32Z Files changed: platformio.ini Patch: @@ -44,13 +44,15 @@ build_unflags = -std=gnu++11 # The correct flag will be set by the cppflags pyth build_flags = -D OSW_TARGET_PLATFORM_HEADER='"platform/LIGHT_EDITION_V3_3.h"' -D OSW_FEATURE_STATS_STEPS + -D OSW_SERVICE_CONSOLE -D OSW_FEATURE_WIFI build_type = debug [env:LIGHT_EDITION_V4_0] build_flags = -D OSW_TARGET_PLATFORM_HEADER='"platform/LIGHT_EDITION_V4_0.h"' -D OSW_FEATURE_STATS_STEPS + -D OSW_SERVICE_CONSOLE -D OSW_FEATURE_WIFI -D OSW_FEATURE_WIFI_ONBOOT build_type = debug @@ -60,6 +62,7 @@ build_type = debug build_flags = -D OSW_TARGET_PLATFORM_HEADER='"platform/LIGHT_EDITION_V3_3.h"' -D OSW_FEATURE_LUA + -D OSW_SERVICE_CONSOLE -D OSW_FEATURE_WIFI -D LUA_C89_NUMBERS ; Required by OSW_FEATURE_LUA extra_scripts = @@ -78,6 +81,7 @@ build_flags = -D BOARD_HAS_PSRAM -mfix-esp32-psram-cache-issue -D OSW_FEATURE_STATS_STEPS + -D OSW_SERVICE_CONSOLE -D OSW_FEATURE_WIFI -D OSW_FEATURE_WIFI_APST -D OSW_FEATURE_WIFI_ONBOOT @@ -92,6 +96,7 @@ build_flags = -D BOARD_HAS_PSRAM -mfix-esp32-psram-cache-issue -D OSW_FEATURE_STATS_STEPS + -D OSW_SERVICE_CONSOLE -D OSW_FEATURE_WIFI -D OSW_FEATURE_WIFI_APST -D OSW_FEATURE_WIFI_ONBOOT Commit SHA: 0607210a1ff0dacd2652a97b9af48df3e539da79 Author: simonmicro Date: 2024-04-13T08:44:32Z Files changed: src/main.cpp Patch: @@ -205,7 +205,7 @@ void loop() { main_mainDrawer.registerApp("GPS", new OswAppV2Compat("osw.gps.mc", "Magnetometer Calibrate", gpsOswAppMC)); #endif -#if OSW_APPS_EXAMPLES == 1 +#ifdef OSW_APPS_EXAMPLES // For a short "How to write your own apps" see the examples below main_mainDrawer.registerAppLazy<OswAppExampleV2>(LANG_EXAMPLES); // only v2 apps support lazy loading (for now) static OswAppExampleV1 exampleV1; // this is a static object, so it will be kept in memory until the device is reset - but it kind of defeats the purpose of lazy loading (static object = initialized on bootup, not on first use) Commit SHA: 0607210a1ff0dacd2652a97b9af48df3e539da79 Author: simonmicro Date: 2024-04-13T08:44:32Z Files changed: src/osw_config.cpp Patch: @@ -87,6 +87,7 @@ void OswConfig::reset(bool clearWholeNVS) { bool res; if(clearWholeNVS) { this-&gt;prefs.end(); + OSW_LOG_D("Formatting NVS partition..."); res = nvs_flash_erase() == ESP_OK; assert(res); res = nvs_flash_init() == ESP_OK; @@ -155,6 +156,18 @@ void OswConfig::setField(String id, String value) { this-&gt;notifyChange(); } +void OswConfig::resetField(String id) { + unsigned char i = 0; + for (; i &lt; oswConfigKeysCount; i++) { + OswConfigKey* key = oswConfigKeys[i]; + if(String(key-&gt;id) == id) { + key-&gt;fromString(key-&gt;toDefaultString().c_str()); + break; + } + } + this-&gt;notifyChange(); +} + void OswConfig::notifyChange() { // Reload parts of the OS, which buffer values // OswUI::getInstance()-&gt;resetTextColors(); // nope - this is done by the ui itself Commit SHA: 0607210a1ff0dacd2652a97b9af48df3e539da79 Author: simonmicro Date: 2024-04-13T08:44:32Z Files changed: src/services/OswServiceTaskConsole.cpp Patch: @@ -0,0 +1,187 @@ +#include "./services/OswServiceTaskConsole.h" +#include "osw_hal.h" + +void OswServiceTaskConsole::setup() { + OswServiceTask::setup(); + OSW_LOG_I("Console is now enabled."); +#ifdef NDEBUG + this-&gt; m_locked = true; // in release mode the console is locked by default +#endif + this-&gt;newPrompt(); +} + +void OswServiceTaskConsole::loop() { + while(true) { + if(!Serial.available()) break; + char c = Serial.read(); + switch (c) { + case 10: // LF + case 13: // CR + this-&gt;runPrompt(); + this-&gt;newPrompt(); + break; + case 8: // backspace + case 127: // delete + case 27: // escape + if(this-&gt;m_inputBuffer.length() &gt; 0) { + this-&gt;m_inputBuffer.pop_back(); + } + Serial.print(c); + break; + case 9: // tab + Serial.println(); // finish the prompt line + this-&gt;showHelp(); + this-&gt;showPrompt(); + break; + default: + if(32 &lt;= c and c &lt;= 126) { // printable characters + this-&gt;m_inputBuffer += c; + Serial.print(c); // echo the entered character back + } else { + Serial.print((char) 0x07); // bell + OSW_LOG_D("Unprocessable character (",(int) c, "): ", c); + } + } + } +} + +void OswServiceTaskConsole::newPrompt() { + this-&gt;m_inputBuffer.clear(); + if(this-&gt;m_locked) return; + this-&gt;showPrompt(); +} + +void OswServiceTaskConsole::showPrompt() { + if (this-&gt;m_configuring) { + Serial.print("OSW (configure) &gt; "); + } else { + Serial.print("OSW &gt; "); + } + if(!this-&gt;m_inputBuffer.empty()) { + Serial.print(this-&gt;m_inputBuffer.c_str()); + } +} + +void OswServiceTaskConsole::runPrompt() { + Serial.println(); // finish the prompt line + if(this-&gt;m_inputBuffer.empty()) return; + if(this-&gt;m_locked) { + Serial.println("Console is locked! Enter \"unlock\" to unlock."); + if(this-&gt;m_inputBuffer == "unlock") { + this-&gt;m_locked = false; + } + return; + } + // command convention: show only what was asked (preferably machine readable), only on error be verbose + bool processed = true; + if (this-&gt;m_configuring) { + if (this-&gt;m_inputBuffer == "clear") { + OswConfig::getInstance()-&gt;reset(false); + } else if (this-&gt;m_inputBuffer == "exit") { + this-&gt;m_configuring = false; + } else if (this-&gt;m_inputBuffer.find("get ") == 0 and this-&gt;m_inputBuffer.length() &gt; 4) { + auto key = this-&gt;m_inputBuffer.substr(4); + for (auto i = 0; i &lt; oswConfigKeysCount; i++) { + if(oswConfigKeys[i]-&gt;id == key) { + Serial.println(oswConfigKeys[i]-&gt;toString()); + break; + } + } + } else if (this-&gt;m_inputBuffer.find("info ") == 0 and this-&gt;m_inputBuffer.length() &gt; 5) { + auto key = this-&gt;m_inputBuffer.substr(5); + Serial.println(OswConfig::getInstance()-&gt;getFieldJson(key.c_str())); + } else if (this-&gt;m_inputBuffer == "help") { + this-&gt;showHelp(); + } else if (this-&gt;m_inputBuffer == "list") { + for (auto i = 0; i &lt; oswConfigKeysCount; i++) { + Serial.println(oswConfigKeys[i]-&gt;id); + } + } else if (this-&gt;m_inputBuffer.find("reset ") == 0 and this-&gt;m_inputBuffer.length() &gt; 7) { + auto key = this-&gt;m_inputBuffer.substr(7); + OswConfig::getInstance()-&gt;enableWrite(); + OswConfig::getInstance()-&gt;resetField(key.c_str()); + OswConfig::getInstance()-&gt;disableWrite(); + } else if (this-&gt;m_inputBuffer.find("set ") == 0 and this-&gt;m_inputBuffer.length() &gt; 5) { + auto key = this-&gt;m_inputBuffer.substr(4); // "<id> <value>" + auto space = key.find(" ", 0); + if (space == std::string::npos) { + Serial.println("Invalid command."); + return; + } + auto value = key.substr(space + 1); // "<value>" + key = key.substr(0, space); // "<id>" + OswConfig::getInstance()-&gt;enableWrite(); + OswConfig::getInstance()-&gt;setField(key.c_str(), value.c_str()); + OswConfig::getInstance()-&gt;disableWrite(); + } else { + processed = false; + } + } else { + if (this-&gt;m_inputBuffer == "configure") { + this-&gt;m_configuring = true; + } else if (this-&gt;m_inputBuffer == "help") { + this-&gt;showHelp(); +#ifdef OSW_FEATURE_WIFI + } else if (this-&gt;m_inputBuffer == "hostname") { + Serial.println(OswConfigAllKeys::hostname.get()); +#endif + } else if (this-&gt;m_inputBuffer == "lock") { + this-&gt;m_locked = true; +#ifndef OSW_EMULATOR + } else if (this-&gt;m_inputBuffer == "reboot") { + // this does not work in the emulator as it is running under an own thread, of which the shutdown-exception is not captured - populating here and crashing + ESP.restart(); +#endif + } else if (this-&gt;m_inputBuffer == "time") { + Serial.println(OswHal::getInstance()-&gt;getUTCTime()); + } else if (this-&gt;m_inputBuffer == "wipe") { + OswConfig::getInstance()-&gt;reset(true); + } else { + processed = false; + } + } + // show help if the command was not processed + if (!processed) { + Serial.println("Unknown command."); + Serial.println(); + this-&gt;showHelp(); + this-&gt;m_lockCounter++; + } + // in case of garbage input, lock the console after 16 attempts + if (this-&gt;m_lockCounter &gt; 16) { + this-&gt;m_locked = true; + this-&gt;m_lockCounter = 0; + } +} + +void OswServiceTaskConsole::showHelp() { + Serial.println("Available commands:"); + // let's try to be civil and show the commands in alphabetical order + if (this-&gt;m_configuring) { + Serial.println(" clear - reset all keys to default values"); + Serial.println(" exit - leave configuration mode"); + Serial.println(" get <id> - get a value for a key"); + Serial.println(" help - show this help"); + Serial.println(" info <id> - show more information about a key"); + Serial.println(" list - show all keys"); + Serial.println(" reset <id> - reset a key to default value"); + Serial.println(" set <id> <value> - set a value for a key (value is everything until the end of the line)"); + } else { + Serial.println(" configure - enter configuration mode"); + Serial.println(" help - show this help"); +#ifdef OSW_FEATURE_WIFI + Serial.println(" hostname - show the device hostname"); +#endif + Serial.println(" lock - lock the console"); +#ifndef OSW_EMULATOR + Serial.println(" reboot - warm-start the device forcefully"); +#endif + Serial.println(" time - show current UTC time"); + Serial.println(" wipe - format NVS partition and reset configuration"); + } +} + +void OswServiceTaskConsole::stop() { + OSW_LOG_I("Console is now disabled."); + OswServiceTask::stop(); +} \ No newline at end of file Commit SHA: 0607210a1ff0dacd2652a97b9af48df3e539da79 Author: simonmicro Date: 2024-04-13T08:44:32Z Files changed: src/services/OswServiceTaskExample.cpp Patch: @@ -1,6 +1,5 @@ -#include "./services/OswServiceTaskExample.h" #include "osw_hal.h" -#include <time.h> +#include "./services/OswServiceTaskExample.h" void OswServiceTaskExample::setup() { OswServiceTask::setup(); @@ -16,6 +15,6 @@ void OswServiceTaskExample::loop() { } void OswServiceTaskExample::stop() { - OswServiceTask::stop(); OSW_LOG_I(__FUNCTION__, "()"); -} \ No newline at end of file + OswServiceTask::stop(); +} Commit SHA: 0607210a1ff0dacd2652a97b9af48df3e539da79 Author: simonmicro Date: 2024-04-13T08:44:32Z Files changed: src/services/OswServiceTaskWebserver.cpp Patch: @@ -297,8 +297,8 @@ void OswServiceTaskWebserver::loop() { } void OswServiceTaskWebserver::stop() { - OswServiceTask::stop(); this-&gt;disableWebserver(); //Make sure the webserver is also stopped + OswServiceTask::stop(); } void OswServiceTaskWebserver::enableWebserver() { Commit SHA: 0607210a1ff0dacd2652a97b9af48df3e539da79 Author: simonmicro Date: 2024-04-13T08:44:32Z Files changed: src/services/OswServiceTaskWiFi.cpp Patch: @@ -137,8 +137,8 @@ void OswServiceTaskWiFi::selectCredentials() { } void OswServiceTaskWiFi::stop() { - OswServiceTask::stop(); this-&gt;disableWiFi(); + OswServiceTask::stop(); } /** Commit SHA: 0607210a1ff0dacd2652a97b9af48df3e539da79 Author: simonmicro Date: 2024-04-13T08:44:32Z Files changed: src/services/OswServiceTasks.cpp Patch: @@ -5,13 +5,17 @@ #include "services/OswServiceTaskGPS.h" #include "services/OswServiceTaskMemMonitor.h" #include "services/OswServiceTaskNotifier.h" +#include "services/OswServiceTaskConsole.h" #ifdef OSW_FEATURE_WIFI #include "services/OswServiceTaskWiFi.h" #include "services/OswServiceTaskWebserver.h" #endif #include "osw_util.h" namespace OswServiceAllTasks { +#ifdef OSW_SERVICE_EXAMPLE +OswServiceTaskExample example; +#endif // OswServiceTaskExample example; #if SERVICE_BLE_COMPANION == 1 OswServiceTaskBLECompanion bleCompanion; @@ -30,6 +34,9 @@ OswServiceTaskNotifier notifier; #ifndef OSW_EMULATOR OswServiceTaskMemMonitor memory; #endif +#ifdef OSW_SERVICE_CONSOLE +OswServiceTaskConsole console; +#endif } // namespace OswServiceAllTasks OswServiceTask* oswServiceTasks[] = { @@ -40,13 +47,18 @@ OswServiceTask* oswServiceTasks[] = { &amp; OswServiceAllTasks::gps, #endif -//&amp;OswServiceAllTasks::example, +#ifdef OSW_SERVICE_EXAMPLE + &amp; OswServiceAllTasks::example, +#endif #ifdef OSW_FEATURE_WIFI &amp; OswServiceAllTasks::wifi, &amp;OswServiceAllTasks::webserver, #endif #if OSW_SERVICE_NOTIFIER == 1 &amp; OswServiceAllTasks::notifier, #endif +#ifdef OSW_SERVICE_CONSOLE + &amp; OswServiceAllTasks::console, +#endif #ifndef OSW_EMULATOR #ifndef NDEBUG &amp; OswServiceAllTasks::memory Commit SHA: 477ce5ccd69bda5c44f53e3b230f8a9c54217ed6 Author: Junio C Hamano Date: 2024-08-14T21:17:22Z Files changed: Documentation/RelNotes/2.47.0.txt Patch: @@ -16,6 +16,11 @@ UI, Workflows &amp; Features the end of the file, just like it omits blank lines before the next function. + * The value of http.proxy can have "path" at the end for a socks + proxy that listens to a unix-domain socket, but we started to + discard it when we taught proxy auth code path to use the + credential helpers, which has been corrected. + Performance, Internal Implementation, Development Support etc. -------------------------------------------------------------- @@ -35,6 +40,17 @@ Performance, Internal Implementation, Development Support etc. * Some project conventions have been added to CodingGuidelines. + * In the refs subsystem, implicit reliance of the_repository has been + eliminated; the repository associated with the ref store object is + used instead. + + * Various tests in reftable library have been rewritten using the unit test + framework. + + * A test that fails on an unusually slow machine was found, and made + less likely to cause trouble by lengthening the expiry value it + uses. + Fixes since v2.46 ----------------- @@ -69,9 +85,49 @@ Fixes since v2.46 corrected. (merge 63ad8dbf16 dh/encoding-trace-optim later to maint). + * More leakfixes. + (merge f30bfafcd4 ps/leakfixes-part-3 later to maint). + + * The credential helper to talk to OSX keychain sometimes sent + garbage bytes after the username, which has been corrected. + (merge b201316835 jk/osxkeychain-username-is-nul-terminated later to maint). + + * A recent update broke "git ls-remote" used outside a repository, + which has been corrected. + (merge 9e89dcb66a ps/ls-remote-out-of-repo-fix later to maint). + + * The patch parser in 'git apply' has been a bit more lenient against + unexpected mode bits, like 100664, recorded on extended header lines. + (merge e95d515141 jk/apply-patch-mode-check-fix later to maint). + + * "git config --value=foo --fixed-value section.key newvalue" barfed + when the existing value in the configuration file used the + valueless true syntax, which has been corrected. + (merge 615d2de3b4 tb/config-fixed-value-with-valueless-true later to maint). + + * The patch parser in "git patch-id" has been tightened to avoid + getting confused by lines that look like a patch header in the log + message. + (merge a6e9429f72 jc/patch-id later to maint). + + * "git reflog expire" failed to honor annotated tags when computing + reachable commits. + (merge 5133ead528 jc/reflog-expire-lookup-commit-fix later to maint). + + * A flakey test and incorrect calls to strtoX() functions have been + fixed. + (merge ec60bb9fc4 kl/test-fixes later to maint). + * Other code cleanup, docfix, build fix, etc. (merge 8db8786fc2 jt/doc-post-receive-hook-update later to maint). (merge 1c473dd6af tn/doc-commit-fix later to maint). (merge bb0498b1bb jc/how-to-maintain-updates later to maint). (merge 6e71d6ac7c ks/unit-test-comment-typofix later to maint). (merge 63ee933383 ps/p4-tests-updates later to maint). + (merge 7c7516b8db jc/jl-git-no-advice-fix later to maint). + (merge c3d034df16 jc/leakfix-hashfile later to maint). + (merge d98d9c77e5 jc/leakfix-mailmap later to maint). + (merge c199707496 jr/ls-files-expand-literal-doc later to maint). + (merge e2e373ba82 ss/packed-ref-store-leakfix later to maint). + (merge 0c4d5aa22d rs/use-decimal-width later to maint). + (merge 67be8c4de5 jc/document-use-of-local later to maint). Commit SHA: d63912374263225b93ababff5b5fb78b68db5954 Author: Junio C Hamano Date: 2024-08-14T21:54:58Z Files changed: t/t7704-repack-cruft.sh Patch: @@ -330,7 +330,7 @@ test_expect_success '--max-cruft-size with pruning' ' # repack (and prune) with a --max-cruft-size to ensure # that we appropriately split the resulting set of packs git repack -d --cruft --max-cruft-size=1M \ - --cruft-expiration=10.seconds.ago &amp;&amp; + --cruft-expiration=1000.seconds.ago &amp;&amp; ls $packdir/pack-*.mtimes | sort &gt;cruft.after &amp;&amp; for cruft in $(cat cruft.after) Commit SHA: dd59778f763f9e8d54d04747880e2f0a9fcd708f Author: Junio C Hamano Date: 2024-08-14T21:54:58Z Files changed: Documentation/CodingGuidelines Patch: @@ -185,8 +185,8 @@ For shell scripts specifically (not exhaustive): - Even though "local" is not part of POSIX, we make heavy use of it in our test suite. We do not use it in scripted Porcelains, and - hopefully nobody starts using "local" before they are reimplemented - in C ;-) + hopefully nobody starts using "local" before all shells that matter + support it (notably, ksh from AT&amp;T Research does not support it yet). - Some versions of shell do not understand "export variable=value", so we write "variable=value" and then "export variable" on two Commit SHA: 4a443f00c4988e1e59e919c3c4a8873a0d1c2b5a Author: Junio C Hamano Date: 2024-08-14T21:54:57Z Files changed: log-tree.c Patch: @@ -31,6 +31,7 @@ #include "tree.h" #include "wildmatch.h" #include "write-or-die.h" +#include "pager.h" static struct decoration name_decoration = { "object names" }; static int decoration_loaded; @@ -411,16 +412,6 @@ void show_decorations(struct rev_info *opt, struct commit *commit) strbuf_release(&amp;sb); } -static unsigned int digits_in_number(unsigned int number) -{ - unsigned int i = 10, result = 1; - while (i &lt;= number) { - i *= 10; - result++; - } - return result; -} - void fmt_output_subject(struct strbuf *filename, const char *subject, struct rev_info *info) @@ -464,7 +455,7 @@ void fmt_output_email_subject(struct strbuf *sb, struct rev_info *opt) strbuf_addf(sb, "Subject: [%s%s%0*d/%d] ", opt-&gt;subject_prefix, *opt-&gt;subject_prefix ? " " : "", - digits_in_number(opt-&gt;total), + decimal_width(opt-&gt;total), opt-&gt;nr, opt-&gt;total); } else if (opt-&gt;total == 0 &amp;&amp; opt-&gt;subject_prefix &amp;&amp; *opt-&gt;subject_prefix) { strbuf_addf(sb, "Subject: [%s] ", Commit SHA: 81903d04729f9402d0dae98caaba71f46dee5735 Author: Junio C Hamano Date: 2024-08-14T21:54:56Z Files changed: refs/files-backend.c Patch: @@ -155,6 +155,7 @@ static void files_ref_store_release(struct ref_store *ref_store) free_ref_cache(refs-&gt;loose); free(refs-&gt;gitcommondir); ref_store_release(refs-&gt;packed_ref_store); + free(refs-&gt;packed_ref_store); } static void files_reflog_path(struct files_ref_store *refs, Commit SHA: 7b11e20bfff8cd9e448290709070266ca9d0c74f Author: Junio C Hamano Date: 2024-08-14T21:54:56Z Files changed: Makefile Patch: @@ -1343,6 +1343,7 @@ UNIT_TEST_PROGRAMS += t-reftable-basics UNIT_TEST_PROGRAMS += t-reftable-merged UNIT_TEST_PROGRAMS += t-reftable-pq UNIT_TEST_PROGRAMS += t-reftable-record +UNIT_TEST_PROGRAMS += t-reftable-tree UNIT_TEST_PROGRAMS += t-strbuf UNIT_TEST_PROGRAMS += t-strcmp-offset UNIT_TEST_PROGRAMS += t-strvec @@ -2685,7 +2686,6 @@ REFTABLE_TEST_OBJS += reftable/dump.o REFTABLE_TEST_OBJS += reftable/readwrite_test.o REFTABLE_TEST_OBJS += reftable/stack_test.o REFTABLE_TEST_OBJS += reftable/test_framework.o -REFTABLE_TEST_OBJS += reftable/tree_test.o TEST_OBJS := $(patsubst %$X,%.o,$(TEST_PROGRAMS)) $(patsubst %,t/helper/%,$(TEST_BUILTINS_OBJS)) Commit SHA: 7b11e20bfff8cd9e448290709070266ca9d0c74f Author: Junio C Hamano Date: 2024-08-14T21:54:56Z Files changed: reftable/reftable-tests.h Patch: @@ -14,7 +14,6 @@ int block_test_main(int argc, const char **argv); int record_test_main(int argc, const char **argv); int readwrite_test_main(int argc, const char **argv); int stack_test_main(int argc, const char **argv); -int tree_test_main(int argc, const char **argv); int reftable_dump_main(int argc, char *const *argv); #endif Commit SHA: 7b11e20bfff8cd9e448290709070266ca9d0c74f Author: Junio C Hamano Date: 2024-08-14T21:54:56Z Files changed: reftable/tree.c Patch: @@ -39,25 +39,20 @@ struct tree_node *tree_search(void *key, struct tree_node **rootp, void infix_walk(struct tree_node *t, void (*action)(void *arg, void *key), void *arg) { - if (t-&gt;left) { + if (t-&gt;left) infix_walk(t-&gt;left, action, arg); - } action(arg, t-&gt;key); - if (t-&gt;right) { + if (t-&gt;right) infix_walk(t-&gt;right, action, arg); - } } void tree_free(struct tree_node *t) { - if (!t) { + if (!t) return; - } - if (t-&gt;left) { + if (t-&gt;left) tree_free(t-&gt;left); - } - if (t-&gt;right) { + if (t-&gt;right) tree_free(t-&gt;right); - } reftable_free(t); } Commit SHA: 7b11e20bfff8cd9e448290709070266ca9d0c74f Author: Junio C Hamano Date: 2024-08-14T21:54:56Z Files changed: reftable/tree_test.c Patch: @@ -1,60 +0,0 @@ -/* -Copyright 2020 Google LLC - -Use of this source code is governed by a BSD-style -license that can be found in the LICENSE file or at -https://developers.google.com/open-source/licenses/bsd -*/ - -#include "system.h" -#include "tree.h" - -#include "test_framework.h" -#include "reftable-tests.h" - -static int test_compare(const void *a, const void *b) -{ - return (char *)a - (char *)b; -} - -struct curry { - void *last; -}; - -static void check_increasing(void *arg, void *key) -{ - struct curry *c = arg; - if (c-&gt;last) { - EXPECT(test_compare(c-&gt;last, key) &lt; 0); - } - c-&gt;last = key; -} - -static void test_tree(void) -{ - struct tree_node *root = NULL; - - void *values[11] = { NULL }; - struct tree_node *nodes[11] = { NULL }; - int i = 1; - struct curry c = { NULL }; - do { - nodes[i] = tree_search(values + i, &amp;root, &amp;test_compare, 1); - i = (i * 7) % 11; - } while (i != 1); - - for (i = 1; i &lt; ARRAY_SIZE(nodes); i++) { - EXPECT(values + i == nodes[i]-&gt;key); - EXPECT(nodes[i] == - tree_search(values + i, &amp;root, &amp;test_compare, 0)); - } - - infix_walk(root, check_increasing, &amp;c); - tree_free(root); -} - -int tree_test_main(int argc, const char *argv[]) -{ - RUN_TEST(test_tree); - return 0; -} Commit SHA: 7b11e20bfff8cd9e448290709070266ca9d0c74f Author: Junio C Hamano Date: 2024-08-14T21:54:56Z Files changed: t/helper/test-reftable.c Patch: @@ -6,7 +6,6 @@ int cmd__reftable(int argc, const char **argv) { /* test from simple to complex. */ block_test_main(argc, argv); - tree_test_main(argc, argv); readwrite_test_main(argc, argv); stack_test_main(argc, argv); return 0; Commit SHA: 7b11e20bfff8cd9e448290709070266ca9d0c74f Author: Junio C Hamano Date: 2024-08-14T21:54:56Z Files changed: t/unit-tests/t-reftable-tree.c Patch: @@ -0,0 +1,84 @@ +/* +Copyright 2020 Google LLC + +Use of this source code is governed by a BSD-style +license that can be found in the LICENSE file or at +https://developers.google.com/open-source/licenses/bsd +*/ + +#include "test-lib.h" +#include "reftable/tree.h" + +static int t_compare(const void *a, const void *b) +{ + return (char *)a - (char *)b; +} + +struct curry { + void **arr; + size_t len; +}; + +static void store(void *arg, void *key) +{ + struct curry *c = arg; + c-&gt;arr[c-&gt;len++] = key; +} + +static void t_tree_search(void) +{ + struct tree_node *root = NULL; + void *values[11] = { 0 }; + struct tree_node *nodes[11] = { 0 }; + size_t i = 1; + + /* + * Pseudo-randomly insert the pointers for elements between + * values[1] and values[10] (inclusive) in the tree. + */ + do { + nodes[i] = tree_search(&amp;values[i], &amp;root, &amp;t_compare, 1); + i = (i * 7) % 11; + } while (i != 1); + + for (i = 1; i &lt; ARRAY_SIZE(nodes); i++) { + check_pointer_eq(&amp;values[i], nodes[i]-&gt;key); + check_pointer_eq(nodes[i], tree_search(&amp;values[i], &amp;root, &amp;t_compare, 0)); + } + + check(!tree_search(values, &amp;root, t_compare, 0)); + tree_free(root); +} + +static void t_infix_walk(void) +{ + struct tree_node *root = NULL; + void *values[11] = { 0 }; + void *out[11] = { 0 }; + struct curry c = { + .arr = (void **) &amp;out, + }; + size_t i = 1; + size_t count = 0; + + do { + tree_search(&amp;values[i], &amp;root, t_compare, 1); + i = (i * 7) % 11; + count++; + } while (i != 1); + + infix_walk(root, &amp;store, &amp;c); + for (i = 1; i &lt; ARRAY_SIZE(values); i++) + check_pointer_eq(&amp;values[i], out[i - 1]); + check(!out[i - 1]); + check_int(c.len, ==, count); + tree_free(root); +} + +int cmd_main(int argc, const char *argv[]) +{ + TEST(t_tree_search(), "tree_search works"); + TEST(t_infix_walk(), "infix_walk works"); + + return test_done(); +} Commit SHA: 61fd5de05fbb20b07a36b9f099dd86db7fa85db0 Author: Junio C Hamano Date: 2024-08-14T21:54:55Z Files changed: builtin/get-tar-commit-id.c Patch: @@ -35,6 +35,7 @@ int cmd_get_tar_commit_id(int argc, const char **argv UNUSED, const char *prefix if (header-&gt;typeflag[0] != TYPEFLAG_GLOBAL_HEADER) return 1; + errno = 0; len = strtol(content, &amp;end, 10); if (errno == ERANGE || end == content || len &lt; 0) return 1; Commit SHA: 61fd5de05fbb20b07a36b9f099dd86db7fa85db0 Author: Junio C Hamano Date: 2024-08-14T21:54:55Z Files changed: ref-filter.c Patch: @@ -1628,6 +1628,7 @@ static void grab_date(const char *buf, struct atom_value *v, const char *atomnam timestamp = parse_timestamp(eoemail + 2, &amp;zone, 10); if (timestamp == TIME_MAX) goto bad; + errno = 0; tz = strtol(zone, NULL, 10); if ((tz == LONG_MIN || tz == LONG_MAX) &amp;&amp; errno == ERANGE) goto bad; Commit SHA: 61fd5de05fbb20b07a36b9f099dd86db7fa85db0 Author: Junio C Hamano Date: 2024-08-14T21:54:55Z Files changed: t/helper/test-json-writer.c Patch: @@ -415,6 +415,7 @@ static void get_i(struct line *line, intmax_t *s_in) get_s(line, &amp;s); + errno = 0; *s_in = strtol(s, &amp;endptr, 10); if (*endptr || errno == ERANGE) die("line[%d]: invalid integer value", line-&gt;nr); @@ -427,6 +428,7 @@ static void get_d(struct line *line, double *s_in) get_s(line, &amp;s); + errno = 0; *s_in = strtod(s, &amp;endptr); if (*endptr || errno == ERANGE) die("line[%d]: invalid float value", line-&gt;nr); Commit SHA: 61fd5de05fbb20b07a36b9f099dd86db7fa85db0 Author: Junio C Hamano Date: 2024-08-14T21:54:55Z Files changed: t/helper/test-trace2.c Patch: @@ -26,6 +26,7 @@ static int get_i(int *p_value, const char *data) if (!data || !*data) return MyError; + errno = 0; *p_value = strtol(data, &amp;endptr, 10); if (*endptr || errno == ERANGE) return MyError; Commit SHA: 61fd5de05fbb20b07a36b9f099dd86db7fa85db0 Author: Junio C Hamano Date: 2024-08-14T21:54:55Z Files changed: t/t6421-merge-partial-clone.sh Patch: @@ -230,8 +230,9 @@ test_expect_merge_algorithm failure success 'Objects downloaded for single relev grep fetch_count trace.output | cut -d "|" -f 9 | tr -d " ." &gt;actual &amp;&amp; test_cmp expect actual &amp;&amp; - # Check the number of fetch commands exec-ed - grep d0.*fetch.negotiationAlgorithm trace.output &gt;fetches &amp;&amp; + # Check the number of fetch commands exec-ed by filtering trace to + # child_start events by the top-level program (2nd field == d0) + grep " d0 .* child_start .*fetch.negotiationAlgorithm" trace.output &gt;fetches &amp;&amp; test_line_count = 2 fetches &amp;&amp; git rev-list --objects --all --missing=print | @@ -318,8 +319,9 @@ test_expect_merge_algorithm failure success 'Objects downloaded when a directory grep fetch_count trace.output | cut -d "|" -f 9 | tr -d " ." &gt;actual &amp;&amp; test_cmp expect actual &amp;&amp; - # Check the number of fetch commands exec-ed - grep d0.*fetch.negotiationAlgorithm trace.output &gt;fetches &amp;&amp; + # Check the number of fetch commands exec-ed by filtering trace to + # child_start events by the top-level program (2nd field == d0) + grep " d0 .* child_start .*fetch.negotiationAlgorithm" trace.output &gt;fetches &amp;&amp; test_line_count = 1 fetches &amp;&amp; git rev-list --objects --all --missing=print | @@ -422,8 +424,9 @@ test_expect_merge_algorithm failure success 'Objects downloaded with lots of ren grep fetch_count trace.output | cut -d "|" -f 9 | tr -d " ." &gt;actual &amp;&amp; test_cmp expect actual &amp;&amp; - # Check the number of fetch commands exec-ed - grep d0.*fetch.negotiationAlgorithm trace.output &gt;fetches &amp;&amp; + # Check the number of fetch commands exec-ed by filtering trace to + # child_start events by the top-level program (2nd field == d0) + grep " d0 .* child_start .*fetch.negotiationAlgorithm" trace.output &gt;fetches &amp;&amp; test_line_count = 4 fetches &amp;&amp; git rev-list --objects --all --missing=print | Commit SHA: 494c9788e40dab99492f10658852010f4a31d358 Author: Junio C Hamano Date: 2024-08-14T21:54:55Z Files changed: reflog.c Patch: @@ -332,7 +332,8 @@ void reflog_expiry_prepare(const char *refname, if (!cb-&gt;cmd.expire_unreachable || is_head(refname)) { cb-&gt;unreachable_expire_kind = UE_HEAD; } else { - commit = lookup_commit(the_repository, oid); + commit = lookup_commit_reference_gently(the_repository, + oid, 1); if (commit &amp;&amp; is_null_oid(&amp;commit-&gt;object.oid)) commit = NULL; cb-&gt;unreachable_expire_kind = commit ? UE_NORMAL : UE_ALWAYS; Commit SHA: 494c9788e40dab99492f10658852010f4a31d358 Author: Junio C Hamano Date: 2024-08-14T21:54:55Z Files changed: t/t1410-reflog.sh Patch: @@ -146,6 +146,14 @@ test_expect_success rewind ' test_line_count = 5 output ' +test_expect_success 'reflog expire should not barf on an annotated tag' ' + test_when_finished "git tag -d v0.tag || :" &amp;&amp; + git -c core.logAllRefUpdates=always \ + tag -a -m "tag name" v0.tag main &amp;&amp; + git reflog expire --dry-run refs/tags/v0.tag 2&gt;err &amp;&amp; + test_grep ! "error: [Oo]bject .* not a commit" err +' + test_expect_success 'corrupt and check' ' corrupt $F &amp;&amp; Commit SHA: 7a95eceb6b015c2d34c42a45c9354b83539f957d Author: Junio C Hamano Date: 2024-08-14T21:54:54Z Files changed: Documentation/git-ls-files.txt Patch: @@ -219,9 +219,9 @@ followed by the ("attr/<eolattr>"). --format=<format>:: A string that interpolates `%(fieldname)` from the result being shown. - It also interpolates `%%` to `%`, and `%xx` where `xx` are hex digits - interpolates to character with hex code `xx`; for example `%00` - interpolates to `\0` (NUL), `%09` to `\t` (TAB) and %0a to ` ` (LF). + It also interpolates `%%` to `%`, and `%xXX` where `XX` are hex digits + interpolates to character with hex code `XX`; for example `%x00` + interpolates to `\0` (NUL), `%x09` to `\t` (TAB) and %x0a to ` ` (LF). --format cannot be combined with `-s`, `-o`, `-k`, `-t`, `--resolve-undo` and `--eol`. \--:: Commit SHA: c147b41f4c450d687759e3fa25c24e5087a97f05 Author: Junio C Hamano Date: 2024-08-14T21:54:53Z Files changed: mailmap.c Patch: @@ -201,8 +201,10 @@ static int read_mailmap_blob(struct string_list *map, const char *name) buf = repo_read_object_file(the_repository, &amp;oid, &amp;type, &amp;size); if (!buf) return error("unable to read mailmap object at %s", name); - if (type != OBJ_BLOB) + if (type != OBJ_BLOB) { + free(buf); return error("mailmap is not a blob: %s", name); + } read_mailmap_string(map, buf); Commit SHA: c147b41f4c450d687759e3fa25c24e5087a97f05 Author: Junio C Hamano Date: 2024-08-14T21:54:53Z Files changed: t/t4203-mailmap.sh Patch: @@ -5,6 +5,7 @@ test_description='.mailmap configurations' GIT_TEST_DEFAULT_INITIAL_BRANCH_NAME=main export GIT_TEST_DEFAULT_INITIAL_BRANCH_NAME +TEST_PASSES_SANITIZE_LEAK=true . ./test-lib.sh test_expect_success 'setup commits and contacts file' ' </format></eolattr></time.h></value></id></id></id></id></id></value></value></id></OswAppExampleV2></time.h></fcntl.h></unistd.h></iostream></OswLogger.h></char></SCREENSHOT></IP_OF_WATCH></p></time.h></value></id></id></id></id></id></value></value></id></OswAppExampleV2></String></this-></this-></String></String></String></int></int></int></int></int></int></int></int></int></int></int></int></int></int></int></int></fstream></iostream></HTTPClient.h></osw_hal.h></OswAppV1.h></gfx_util.h></cstring></HTTPClient.h></time.h></String></optional></int></weather_update_t></int></int></int></int></int></int></int></int></int></int></int></int></int></int></int></int></String></OswAppV1.h></vector></osw_hal.h></fcntl.h></unistd.h></iostream></OswLogger.h></char></SCREENSHOT></IP_OF_WATCH></p></div></div></div><div id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recent Post</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li> <a href="/posts/an_error_occurred_while_preparing_the_installation/">An error occurred while preparing the installation</a><li> <a href="/posts/how_to_disable_android_anti-capture/">How to disable android anti-capture</a><li> <a href="/posts/how_to_search_google_images_by_the_exact_size/">How to Search Google Images by the Exact Size</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/research/">research</a> <a class="post-tag btn btn-outline-primary" href="/tags/develop/">develop</a> <a class="post-tag btn btn-outline-primary" href="/tags/git/">git</a> <a class="post-tag btn btn-outline-primary" href="/tags/blog/">blog</a> <a class="post-tag btn btn-outline-primary" href="/tags/software-developer/">Software Developer</a> <a class="post-tag btn btn-outline-primary" href="/tags/android/">android</a> <a class="post-tag btn btn-outline-primary" href="/tags/diary/">diary</a> <a class="post-tag btn btn-outline-primary" href="/tags/linux/">linux</a> <a class="post-tag btn btn-outline-primary" href="/tags/mobile/">mobile</a> <a class="post-tag btn btn-outline-primary" href="/tags/opensource/">opensource</a></div></div></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/research/">research</a> <a class="post-tag btn btn-outline-primary" href="/tags/develop/">develop</a> <a class="post-tag btn btn-outline-primary" href="/tags/git/">git</a> <a class="post-tag btn btn-outline-primary" href="/tags/blog/">blog</a> <a class="post-tag btn btn-outline-primary" href="/tags/software-developer/">Software Developer</a> <a class="post-tag btn btn-outline-primary" href="/tags/android/">android</a> <a class="post-tag btn btn-outline-primary" href="/tags/diary/">diary</a> <a class="post-tag btn btn-outline-primary" href="/tags/linux/">linux</a> <a class="post-tag btn btn-outline-primary" href="/tags/mobile/">mobile</a> <a class="post-tag btn btn-outline-primary" href="/tags/opensource/">opensource</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div></div><footer><div class="container px-lg-4"><div class='typing'>I'm <STRONG><span class="text"></span></STRONG></div><script> document.addEventListener("DOMContentLoaded", function () { const $text = document.querySelector(".typing .text"); const letters = [ "Developer", "Author", "Creator", "Inventor", "Conductor", "Traveler" ]; const speed = 100; let i = 0; const typing = async () => { const letter = letters[i].split(""); while (letter.length) { await wait(speed); $text.innerHTML += letter.shift(); } await wait(800); remove(); }; const remove = async () => { const letter = letters[i].split(""); while (letter.length) { await wait(speed); letter.pop(); $text.innerHTML = letter.join(""); } i = !letters[i + 1] ? 0 : i + 1; typing(); }; function wait(ms) { return new Promise(res => setTimeout(res, ms)) } setTimeout(typing, 1500); }); </script><div class="d-flex justify-content-center align-items-center text-muted mx-md-3"><p>Using the <a href="https://github.com" target="_blank" rel="noopener">Open-source</a> theme <a href="https://github.com/RuffaloLavoisier/RuffaloLavoisier.github.io" target="_blank" rel="noopener">RuffaloLavoisier</a></p><p>© 2024 <a href="https://github.com/RuffaloLavoisier">Ruffalo</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p></div></div></footer><div id="mask"></div><button id="back-to-top" aria-label="back-to-top" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.0/dist/jquery.min.js,npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/lazysizes@5.3.2/lazysizes.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/page.min.js"></script> <script defer src="/app.js"></script> <script> /* Note: dependent library will be loaded in `js-selector.html` */ SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="px-1 px-sm-2 px-lg-4 px-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5"></p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
